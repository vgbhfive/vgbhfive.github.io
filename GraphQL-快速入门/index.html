<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="G-QBK8PCQC9B">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.vgbhfive.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="示例代码123456789101112131415161718192021222324252627282930313233import graphql.ExecutionResult;import graphql.GraphQL;import graphql.schema.GraphQLSchema;import graphql.schema.StaticDataFetcher;import gr">
<meta property="og:type" content="article">
<meta property="og:title" content="GraphQL-快速入门">
<meta property="og:url" content="https://blog.vgbhfive.cn/GraphQL-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Vgbhfive&#39;s Blog">
<meta property="og:description" content="示例代码123456789101112131415161718192021222324252627282930313233import graphql.ExecutionResult;import graphql.GraphQL;import graphql.schema.GraphQLSchema;import graphql.schema.StaticDataFetcher;import gr">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2019/05/14/5cda56c0d0b8c12981.png">
<meta property="og:image" content="https://i.loli.net/2019/05/14/5cda56c0e084960004.png">
<meta property="og:image" content="https://i.loli.net/2019/05/14/5cda58b10ad1961330.png">
<meta property="og:image" content="https://i.loli.net/2019/05/14/5cda58b13dea638879.png">
<meta property="og:image" content="https://i.loli.net/2019/05/14/5cda5e0da79f980881.png">
<meta property="og:image" content="https://i.loli.net/2019/05/14/5cda601d503bc22376.png">
<meta property="og:image" content="https://i.loli.net/2019/05/14/5cda6929b79e952746.png">
<meta property="og:image" content="https://i.loli.net/2019/05/14/5cda692a5ff1591530.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdb8345c370113435.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdb85dcd934c17126.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdb85dccd91622501.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdb87384045b16308.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdbaceeaf6b187731.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdbae4ed236667697.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdbae4ee4c1444497.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdbae4ed958b39635.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdbb3163635d37988.png">
<meta property="og:image" content="https://i.loli.net/2019/05/15/5cdbb3160c57e42824.png">
<meta property="article:published_time" content="2019-04-27T15:57:58.000Z">
<meta property="article:modified_time" content="2020-02-05T06:26:15.769Z">
<meta property="article:author" content="vgbhfive">
<meta property="article:tag" content="GraphQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2019/05/14/5cda56c0d0b8c12981.png">

<link rel="canonical" href="https://blog.vgbhfive.cn/GraphQL-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>GraphQL-快速入门 | Vgbhfive's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Vgbhfive's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Vgbhfive's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-pictures">

    <a href="/pictures/" rel="section"><i class="fa fa-th fa-fw"></i>Pictures</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.vgbhfive.cn/GraphQL-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
      <meta itemprop="name" content="vgbhfive">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Vgbhfive's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GraphQL-快速入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-27 23:57:58" itemprop="dateCreated datePublished" datetime="2019-04-27T23:57:58+08:00">2019-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-05 14:26:15" itemprop="dateModified" datetime="2020-02-05T14:26:15+08:00">2020-02-05</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> graphql.ExecutionResult;</span><br><span class="line"><span class="keyword">import</span> graphql.GraphQL;</span><br><span class="line"><span class="keyword">import</span> graphql.schema.GraphQLSchema;</span><br><span class="line"><span class="keyword">import</span> graphql.schema.StaticDataFetcher;</span><br><span class="line"><span class="keyword">import</span> graphql.schema.idl.RuntimeWiring;</span><br><span class="line"><span class="keyword">import</span> graphql.schema.idl.SchemaGenerator;</span><br><span class="line"><span class="keyword">import</span> graphql.schema.idl.SchemaParser;</span><br><span class="line"><span class="keyword">import</span> graphql.schema.idl.TypeDefinitionRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> graphql.schema.idl.RuntimeWiring.newRuntimeWiring;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">schema</span> <span class="operator">=</span> <span class="string">&quot;type Query&#123;hello: String&#125; schema&#123;query: Query&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">SchemaParser</span> <span class="variable">schemaParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaParser</span>();</span><br><span class="line">        <span class="type">TypeDefinitionRegistry</span> <span class="variable">typeDefinitionRegistry</span> <span class="operator">=</span> schemaParser.parse(schema);</span><br><span class="line"></span><br><span class="line">        <span class="type">RuntimeWiring</span> <span class="variable">runtimeWiring</span> <span class="operator">=</span> newRuntimeWiring()</span><br><span class="line">                .type(<span class="string">&quot;Query&quot;</span>, builder -&gt; builder.dataFetcher(<span class="string">&quot;hello&quot;</span>, <span class="keyword">new</span> <span class="title class_">StaticDataFetcher</span>(<span class="string">&quot;world&quot;</span>)))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">SchemaGenerator</span> <span class="variable">schemaGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaGenerator</span>();</span><br><span class="line">        <span class="type">GraphQLSchema</span> <span class="variable">graphQLSchema</span> <span class="operator">=</span> schemaGenerator.makeExecutableSchema(typeDefinitionRegistry, runtimeWiring);</span><br><span class="line"></span><br><span class="line">        <span class="type">GraphQL</span> <span class="variable">build</span> <span class="operator">=</span> GraphQL.newGraphQL(graphQLSchema).build();</span><br><span class="line">        <span class="type">ExecutionResult</span> <span class="variable">executionResult</span> <span class="operator">=</span> build.execute(<span class="string">&quot;&#123;hello&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(executionResult.getData().toString());</span><br><span class="line">        <span class="comment">// Prints: &#123;hello=world&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><h4 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h4><p>Relay 是一种构建客户端应用程序的新方法，这些应用程序可以共同定位数据获取要求和React 组件。<br>我们不是将数据提取逻辑放在客户端应用程序的其他部分中 - 或者将此逻辑嵌入到服务器上的自定义端点中 - 而是与React 组件一起共同定位声明性数据获取规范。<br>此声明性规范的语言是GraphQL。</p>
<h4 id="GraphQL"><a href="#GraphQL" class="headerlink" title="GraphQL"></a>GraphQL</h4><p>GraphQL 查询是由服务器解释的字符串，它返回指定格式的数据。<br>示例查询:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  user(id: 3500401) &#123;</span><br><span class="line">    id,</span><br><span class="line">    name,</span><br><span class="line">    isViewerFriend,</span><br><span class="line">    profilePicture(size: 50)  &#123;</span><br><span class="line">      uri,</span><br><span class="line">      width,</span><br><span class="line">      height</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 响应查询:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;user&quot; : &#123;</span><br><span class="line">    &quot;id&quot;: 3500401,</span><br><span class="line">    &quot;name&quot;: &quot;Jing Chen&quot;,</span><br><span class="line">    &quot;isViewerFriend&quot;: true,</span><br><span class="line">    &quot;profilePicture&quot;: &#123;</span><br><span class="line">      &quot;uri&quot;: &quot;http://someurl.cdn/pic.jpg&quot;,</span><br><span class="line">      &quot;width&quot;: 50,</span><br><span class="line">      &quot;height&quot;: 50</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h4><ul>
<li>分层<br>今天的大多数产品开发涉及视图层次结构的创建和操作。为了与这些应用程序的结构保持一致，GraphQL 查询本身是一组分层的字段。查询的形状就像它返回的数据一样。这是产品工程师描述数据要求的自然方式。</li>
<li>以产品为中心<br>GraphQL 是由视图和编写它们的前端工程师的要求无缘无故地驱动的。我们从他们的思维方式和要求开始，并构建实现这一点所必需的语言和运行时。</li>
<li>客户端指定的查询<br>在GraphQL中，查询规范在客户端而不是服务器中编码。这些查询以字段级粒度指定。在没有GraphQL 编写的绝大多数应用程序中，服务器确定在其各种脚本化端点中返回的数据。另一方面，GraphQL查询返回客户端要求的内容，而不再返回。</li>
<li>向后兼容<br>在没有强制升级的已部署本机移动应用程序的世界中，向后兼容性是一项挑战。例如，Facebook 在两周的固定周期内发布应用程序，并承诺维护这些应用程序至少两年。这意味着每个平台至少有 52个版本的客户端在任何给定时间查询我们的服务器。客户端指定的查询简化了对向后兼容性保证的管理。</li>
<li>结构化、任意代码<br>具有字段级粒度的查询语言通常直接查询存储引擎，例如SQL 。相反，GraphQL 将结构强加到服务器上，并公开由任意代码支持的字段。这允许服务器端灵活性和应用程序的整个表面区域上的统一，强大的API。</li>
<li>应用层协议<br>GraphQL 是一种应用层协议，不需要特定的传输。它是由服务器解析和解释的字符串。</li>
<li>强类型<br>GraphQL 是强类型的。给定查询，工具可以确保在执行之前，即在开发时，在GraphQL 类型系统中查询在语法上是正确和有效的，并且服务器可以对响应的形状和性质做出某些保证。这样可以更轻松地构建高质量的客户端工具。</li>
<li>内省<br>GraphQL 是内省的。客户端和工具可以使用GraphQL 语法本身查询类型系统。这是一个用于构建工具和客户端软件的强大平台，例如将输入数据自动解析为强类型接口。它在静态类型语言（如Swift ，Objective-C 和Java ）中特别有用，因为它不需要重复且容易出错的代码将原始的，无类型的JSON 混合到强类型的业务对象中。</li>
</ul>
<h3 id="Spring-Boot-开发"><a href="#Spring-Boot-开发" class="headerlink" title="Spring Boot 开发"></a>Spring Boot 开发</h3><p>详细的开发内容，可以看我的<a target="_blank" rel="noopener" href="https://github.com/vgbhfive/GrapgQLDemo">Github</a>地址。</p>
<hr>

<h3 id="全栈教程"><a href="#全栈教程" class="headerlink" title="全栈教程"></a>全栈教程</h3><p>这里有一个免费的<a target="_blank" rel="noopener" href="https://www.howtographql.com/">开源教程开发网站</a>，你可以试试。</p>
<h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><ul>
<li>模式驱动的开发<br>开发合同（无论是以WSDL 还是Swagger 或其他任何形式）通常会预先深入而准确地理解客户的数据需求，而这种理解通常只是随着时间的推移而发展起来的。GraphQL 通过决定将哪些数据提取到客户端的独占域来方便地消除了这个障碍，从而开启了更顺畅的API演进的路径。GraphQL的自描述性质（通过内省查询）进一步补充了这一点，使得契约优先（或者更确切地说，在GraphQL 语言中的模式优先）方法既自然又简单。<br>GraphQL 中的模式是客户端和服务器之间的中心契约，描述了服务器提供的所有类型的数据以及所有操作（查询和突变）。除了客户端 - 服务器独立性和易于模拟的通常承诺之外，以模式优先的方式开发有助于实现将逻辑结构化为更简单和更简单的功能（单一责任原则）的良好实践，可以方便地用作解析器。</li>
</ul>
<h3 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h3><ul>
<li><p>初始化项目<br>本教程将使用Maven，请选择你喜欢的IDE 和适当的Maven 版本。</p>
</li>
<li><p>定义架构<br>重要的是要注意，解析器函数是字段定义的组成部分，因此是模式的一部分。这意味着模式不仅仅是一个文档，而是一个运行时对象实例。<br>架构可以通过两种方式定义：</p>
</li>
<li><p>以编程方式 - 在代码中手动组装类型定义。</p>
</li>
<li><p>使用模式定义语言（SDL） - 其中模式是从与前面章节中看到的文本语言无关的描述生成的，然后使用解析器函数动态连接。<br>前者并置了字段及其相关的结果，而后者则在数据和行为之间进行了明确的划分。我们将在此的大部分内容中使用SDL ，因为它允许简洁的示例。<br>表示链接的简单类型的SDL 定义可能如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type Link &#123;</span><br><span class="line">  url: String!</span><br><span class="line">  description: String!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 并且获取所有链接的查询方式可以定义为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">  allLinks: [Link]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 最后，包含此查询模式将定义为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">schema &#123;</span><br><span class="line">  query: Query</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 将这些定义保存为一个名为schema.graphqls的文件中。</p>
</li>
<li><p>安装依赖项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.graphql-java&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;graphql-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.0.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.graphql-java&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;graphql-java-tools&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.graphql-java&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;graphql-java-servlet&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.0.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.0.1&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p> 其中对应的版本，可以自行修改。</p>
</li>
<li><p>设置服务器<br>对于jetty ，将插件添加到build部分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;finalName&gt;hackernews&lt;/finalName&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jetty-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;9.4.6.v20170531&lt;/version&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p> 添加以下插件配置，将Java版本设为8，将servlet版本设为3.1。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.5.1&lt;/version&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;source&gt;1.8&lt;/source&gt;</span><br><span class="line">        &lt;target&gt;1.8&lt;/target&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.1.0&lt;/version&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<p> 下面就配置可运行的类。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import com.coxautodev.graphql.tools.SchemaParser;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import graphql.servlet.SimpleGraphQLServlet;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@WebServlet(urlPatterns = &quot;/graphql&quot;)</span><br><span class="line">public class GraphQLEndpoint extends SimpleGraphQLServlet &#123;</span><br><span class="line"></span><br><span class="line">    public GraphQLEndpoint() &#123;</span><br><span class="line">        super(SchemaParser.newParser()</span><br><span class="line">                .file(&quot;schema.graphqls&quot;) //parse the schema file created earlier</span><br><span class="line">                .build()</span><br><span class="line">                .makeExecutableSchema());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 现在启动服务器并访问http：&#x2F;&#x2F;localhost：8080&#x2F;graphql 仍然会导致错误，因为没有连接解析器函数（因此定义的allLinks查询无法执行）。</p>
</li>
</ul>
<h3 id="一个简单的查询"><a href="#一个简单的查询" class="headerlink" title="一个简单的查询"></a>一个简单的查询</h3><ul>
<li><p>查询解析器<br>为了保持强类型和直观设计，通常用等效的Java类表示GraphQL类型，用方法表示字段。graphql-java-tools定义了两种类型的类：数据类，它们为域建模，通常是简单的POJO，以及解析器，它们对查询和突变进行建模并包含解析器函数。通常，两者都需要对单个GraphQL类型进行建模。<br>目前为止的架构如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">type Link &#123;</span><br><span class="line">  url: String!</span><br><span class="line">  description: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Query &#123;</span><br><span class="line">  allLinks: [Link]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">schema &#123;</span><br><span class="line">  query: Query</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 对他建模需要两个类:Link 和Query 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Link</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Link</span><span class="params">(String url, String description)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">        <span class="built_in">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 你还应该创建一个LinkRepository 类，它将整齐地隔离从存储中保存和加载链接的问题。这也使未来的扩展和重构变得更加容易。目前，链接只会保存在内存中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Link&gt; links;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkRepository</span><span class="params">()</span> &#123;</span><br><span class="line">        links = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//add some links to start off with</span></span><br><span class="line">        links.add(<span class="keyword">new</span> <span class="title class_">Link</span>(<span class="string">&quot;http://howtographql.com&quot;</span>, <span class="string">&quot;Your favorite GraphQL page&quot;</span>));</span><br><span class="line">        links.add(<span class="keyword">new</span> <span class="title class_">Link</span>(<span class="string">&quot;http://graphql.org/learn/&quot;</span>, <span class="string">&quot;The official docks&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">getAllLinks</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> links;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveLink</span><span class="params">(Link link)</span> &#123;</span><br><span class="line">        links.add(link);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回链接<br>与Link POJO 不同，Query 模型行为，因为它包含查询的解析器allLinks 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Query</span> <span class="keyword">implements</span> <span class="title class_">GraphQLRootResolver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkRepository linkRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Query</span><span class="params">(LinkRepository linkRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.linkRepository = linkRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">allLinks</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> linkRepository.getAllLinks();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 最后，您可以更新GraphQLEndpoint以在生成架构时正确注册解析器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/graphql&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GraphQLEndpoint</span> <span class="keyword">extends</span> <span class="title class_">SimpleGraphQLServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GraphQLEndpoint</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(buildSchema());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> GraphQLSchema <span class="title function_">buildSchema</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LinkRepository</span> <span class="variable">linkRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkRepository</span>();</span><br><span class="line">        <span class="keyword">return</span> SchemaParser.newParser()</span><br><span class="line">                .file(<span class="string">&quot;schema.graphqls&quot;</span>)</span><br><span class="line">                .resolvers(<span class="keyword">new</span> <span class="title class_">Query</span>(linkRepository))</span><br><span class="line">                .build()</span><br><span class="line">                .makeExecutableSchema();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 注意如何将模式构建逻辑提取到一个单独的方法中，以便于将来添加。<br>如果您现在打开<a target="_blank" rel="noopener" href="http://localhost:8080/graphql?query=%7BallLinks%7Burl%7D%7D">http://localhost:8080/graphql?query={allLinks{url}}</a> ，您将看到您的第一个GraphQL查询正在执行，并为您提供如下结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;allLinks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://howtographql.com&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://graphql.org/learn/&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用GraphiQL进行测试<br>GraphiQL是一个浏览器内的IDE，允许您探索模式，触发查询&#x2F;突变并查看结果。<br>在index.html中添加对应的内容。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;//cdn.jsdelivr.net/npm/graphiql@0.11.2/graphiql.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//cdn.jsdelivr.net/npm/graphiql@0.11.2/graphiql.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> 启动Jetty并打开<a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080/</a> ，你应该会看到一个很酷的环境，你可以测试你到目前为止构建的内容。<br><img src="https://i.loli.net/2019/05/14/5cda56c0d0b8c12981.png"><br> 本次的测试内容：<br><img src="https://i.loli.net/2019/05/14/5cda56c0e084960004.png"></p>
</li>
</ul>
<hr>

<h3 id="突变"><a href="#突变" class="headerlink" title="突变"></a>突变</h3><p>首先描述在SDL 中创建链接的变动：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Mutation &#123;</span><br><span class="line">  createLink(url: String!, description: String!): Link</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 添加此定义</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">schema &#123;</span><br><span class="line">    query: Query</span><br><span class="line">    mutation: Mutation</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>带参数的解析器<br>创建变动的解析器(类似于已有的Query类)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mutation</span> <span class="keyword">implements</span> <span class="title class_">GraphQLRootResolver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkRepository linkRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Mutation</span><span class="params">(LinkRepository linkRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.linkRepository = linkRepository;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Link <span class="title function_">createLink</span><span class="params">(String url, String description)</span> &#123;</span><br><span class="line">        <span class="type">Link</span> <span class="variable">newLink</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Link</span>(url, description);</span><br><span class="line">        linkRepository.saveLink(newLink);</span><br><span class="line">        <span class="keyword">return</span> newLink;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 最后，以与Query 在内部注册相同的方式注册这个新的解析器GraphQLEndpoint#buildSchema：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static GraphQLSchema buildSchema() &#123;</span><br><span class="line">    LinkRepository linkRepository = new LinkRepository();</span><br><span class="line">    return SchemaParser.newParser()</span><br><span class="line">  .file(&quot;schema.graphqls&quot;)</span><br><span class="line">  .resolvers(new Query(linkRepository), new Mutation(linkRepository))</span><br><span class="line">  .build()</span><br><span class="line">  .makeExecutableSchema();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建链接<br>使用GraphiQL重新启动Jetty并测试：<br><img src="https://i.loli.net/2019/05/14/5cda58b10ad1961330.png"><br>验证测试内容：<br><img src="https://i.loli.net/2019/05/14/5cda58b13dea638879.png"></p>
</li>
</ul>
<h4 id="连接器"><a href="#连接器" class="headerlink" title="连接器"></a>连接器</h4><p>尽管它很有趣，但如果GraphQL API 没有连接到其他系统，无论是数据库，第三方API 还是类似的，它都不太可能有用。<br>由于解析器负责获取单个字段的值，因此很容易想象，在单个查询响应中，值可能同时来自多个存储和第三方API，而客户端不会受到影响。</p>
<ul>
<li><p>重构链接类型<br>添加id 字段到Link 类型中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type Link &#123;</span><br><span class="line">    id: ID!</span><br><span class="line">    url: String!</span><br><span class="line">    description: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 类似的，重构Link 类以添加新字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class Link &#123;</span><br><span class="line">    </span><br><span class="line">    private final String id; //the new field</span><br><span class="line">    private final String url;</span><br><span class="line">    private final String description;</span><br><span class="line"></span><br><span class="line">    public Link(String url, String description) &#123;</span><br><span class="line">        this(null, url, description);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Link(String id, String url, String description) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">        this.url = url;</span><br><span class="line">        this.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUrl() &#123;</span><br><span class="line">        return url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getDescription() &#123;</span><br><span class="line">        return description;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接Mongo DB<br>此项目，将使用Mongo DB 作为持久化存储，但通过完全遵循相同的方法，也可以集成其他的任意第三方系统成为解析器的基础服务程序。</p>
</li>
</ul>
<ol>
<li>安装Mongo DB</li>
<li>为项目添加依赖<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mongodb&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mongodb-driver&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.4.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li>重构LinkRepository ，以便它持久化并加载来自MongoDB 的链接<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MongoCollection&lt;Document&gt; links;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkRepository</span><span class="params">(MongoCollection&lt;Document&gt; links)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.links = links;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Link <span class="title function_">findById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> links.find(eq(<span class="string">&quot;_id&quot;</span>, <span class="keyword">new</span> <span class="title class_">ObjectId</span>(id))).first();</span><br><span class="line">        <span class="keyword">return</span> link(doc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">getAllLinks</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Link&gt; allLinks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Document doc : links.find()) &#123;</span><br><span class="line">            allLinks.add(link(doc));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allLinks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveLink</span><span class="params">(Link link)</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        doc.append(<span class="string">&quot;url&quot;</span>, link.getUrl());</span><br><span class="line">        doc.append(<span class="string">&quot;description&quot;</span>, link.getDescription());</span><br><span class="line">        links.insertOne(doc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Link <span class="title function_">link</span><span class="params">(Document doc)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Link</span>(</span><br><span class="line">                doc.get(<span class="string">&quot;_id&quot;</span>).toString(),</span><br><span class="line">                doc.getString(<span class="string">&quot;url&quot;</span>),</span><br><span class="line">                doc.getString(<span class="string">&quot;description&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>将Query 类中的allLinks 方法更新为现在调用linkRepository.getAllLinks() 而不是linkRepository.allLinks() 。</li>
<li>您还必须更新GraphQLEndpoint以连接到MongoDB。<br>links从MongoDB 获取集合并提供给它LinkRepository。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/graphql&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GraphQLEndpoint</span> <span class="keyword">extends</span> <span class="title class_">SimpleGraphQLServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LinkRepository linkRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//Change to `new MongoClient(&quot;&lt;host&gt;:&lt;port&gt;&quot;)`</span></span><br><span class="line">        <span class="comment">//if you don&#x27;t have Mongo running locally on port 27017</span></span><br><span class="line">        <span class="type">MongoDatabase</span> <span class="variable">mongo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MongoClient</span>().getDatabase(<span class="string">&quot;hackernews&quot;</span>);</span><br><span class="line">        linkRepository = <span class="keyword">new</span> <span class="title class_">LinkRepository</span>(mongo.getCollection(<span class="string">&quot;links&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GraphQLEndpoint</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(buildSchema());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> GraphQLSchema <span class="title function_">buildSchema</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SchemaParser.newParser()</span><br><span class="line">                .file(<span class="string">&quot;schema.graphqls&quot;</span>)</span><br><span class="line">                .resolvers(<span class="keyword">new</span> <span class="title class_">Query</span>(linkRepository), <span class="keyword">new</span> <span class="title class_">Mutation</span>(linkRepository))</span><br><span class="line">                .build()</span><br><span class="line">                .makeExecutableSchema();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>性能<br>您可能已经注意到，到目前为止看到的执行策略有些复杂。想象一下，链接描述存储在不同的数据库中。这意味着像这样的查询<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query links &#123;</span><br><span class="line">    allLinks &#123;</span><br><span class="line">      description</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 字段的解析器description（对结果中的每个链接调用一次）将查询其他数据库，因为有多次链接。这是N + 1 问题的典型例子。解决方案是批量处理多个请求并一次解决它们。对于SQL 数据库，所需的解析器将如下所示：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM Descriptions WHERE link_id IN (1,2,3) // fetch descriptions for 3 links at once</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>到目前为止一切都那么好，但如果不跟踪当前用户是谁，就不可能进行大量的交互。要成为一个很酷的Hackernews ，你的应用程序需要能够让用户注册和登录。</p>
<h4 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h4><ol>
<li>定义变量和类型：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">type Mutation &#123;</span><br><span class="line">    #The new mutation</span><br><span class="line">    createUser(name: String!, authProvider: AuthData!): User</span><br><span class="line">    createLink(url: String!, description: String!): Link</span><br><span class="line">&#125;</span><br><span class="line">type User &#123;</span><br><span class="line">    id: ID!</span><br><span class="line">    name: String!</span><br><span class="line">    email: String</span><br><span class="line">    password: String</span><br><span class="line">&#125;    </span><br><span class="line">input AuthData &#123;</span><br><span class="line">    email: String!</span><br><span class="line">    password: String!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>创建的Java 类型：<br>User类：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String email;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, String email, String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>, name, email, password);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String id, String name, String email, String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.email = email;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEmail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 AuthData类：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthData</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthData</span><span class="params">(String email, String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.email = email;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEmail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmail</span><span class="params">(String email)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>那么我觉得还需要一个新的存储库类来加载和存储用户LinkRepository。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MongoCollection&lt;Document&gt; users;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserRepository</span><span class="params">(MongoCollection&lt;Document&gt; users)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.users = users;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByEmail</span><span class="params">(String email)</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> users.find(eq(<span class="string">&quot;email&quot;</span>, email)).first();</span><br><span class="line">        <span class="keyword">return</span> user(doc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> users.find(eq(<span class="string">&quot;_id&quot;</span>, <span class="keyword">new</span> <span class="title class_">ObjectId</span>(id))).first();</span><br><span class="line">        <span class="keyword">return</span> user(doc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">saveUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        doc.append(<span class="string">&quot;name&quot;</span>, user.getName());</span><br><span class="line">        doc.append(<span class="string">&quot;email&quot;</span>, user.getEmail());</span><br><span class="line">        doc.append(<span class="string">&quot;password&quot;</span>, user.getPassword());</span><br><span class="line">        users.insertOne(doc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">                doc.get(<span class="string">&quot;_id&quot;</span>).toString(),</span><br><span class="line">                user.getName(),</span><br><span class="line">                user.getEmail(),</span><br><span class="line">                user.getPassword());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">user</span><span class="params">(Document doc)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (doc == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">                doc.get(<span class="string">&quot;_id&quot;</span>).toString(),</span><br><span class="line">                doc.getString(<span class="string">&quot;name&quot;</span>),</span><br><span class="line">                doc.getString(<span class="string">&quot;email&quot;</span>),</span><br><span class="line">                doc.getString(<span class="string">&quot;password&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在添加新的createUser 解析器之前Mutation ，你必须重构它以接受构造函数中的UserRepository 实例。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mutation</span> <span class="keyword">implements</span> <span class="title class_">GraphQLRootResolver</span> &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkRepository linkRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Mutation</span><span class="params">(LinkRepository linkRepository, UserRepository userRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.linkRepository = linkRepository;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Link <span class="title function_">createLink</span><span class="params">(String url, String description)</span> &#123;</span><br><span class="line">        <span class="comment">//stays the same</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">createUser</span><span class="params">(String name, AuthData auth)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">newUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(name, auth.getEmail(), auth.getPassword());</span><br><span class="line">        <span class="keyword">return</span> userRepository.saveUser(newUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>最后，只需要实例化UserRepository 并更新架构构建逻辑GraphQLEndpoint 。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LinkRepository linkRepository;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UserRepository userRepository; <span class="comment">//the new field    </span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="type">MongoDatabase</span> <span class="variable">mongo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MongoClient</span>().getDatabase(<span class="string">&quot;hackernews&quot;</span>);</span><br><span class="line">    linkRepository = <span class="keyword">new</span> <span class="title class_">LinkRepository</span>(mongo.getCollection(<span class="string">&quot;links&quot;</span>));</span><br><span class="line">    userRepository = <span class="keyword">new</span> <span class="title class_">UserRepository</span>(mongo.getCollection(<span class="string">&quot;users&quot;</span>));</span><br><span class="line">&#125;    </span><br><span class="line"><span class="comment">//the rest is the same    </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> GraphQLSchema <span class="title function_">buildSchema</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SchemaParser.newParser()</span><br><span class="line">            .file(<span class="string">&quot;schema.graphqls&quot;</span>)</span><br><span class="line">            .resolvers(<span class="keyword">new</span> <span class="title class_">Query</span>(linkRepository), <span class="keyword">new</span> <span class="title class_">Mutation</span>(linkRepository, userRepository))</span><br><span class="line">            .build()</span><br><span class="line">            .makeExecutableSchema();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>下面就是测试了。<br><img src="https://i.loli.net/2019/05/14/5cda5e0da79f980881.png"></li>
</ol>
<h4 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h4><ol>
<li>首先在模式中定义新的变异和相关类型：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">type Mutation &#123;</span><br><span class="line">    #other mutations stay the same</span><br><span class="line">    signinUser(auth: AuthData): SigninPayload</span><br><span class="line">&#125;</span><br><span class="line">type SigninPayload &#123;</span><br><span class="line">    token: String</span><br><span class="line">    user: User</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>创建一个新类来为新类型建模<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SigninPayload</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String token;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SigninPayload</span><span class="params">(String token, User user)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.token = token;</span><br><span class="line">        <span class="built_in">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>SigninPayload 数据类包含复杂（非标量）对象User ，所以它需要一个伴随解析器类。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SigninResolver</span> <span class="keyword">implements</span> <span class="title class_">GraphQLResolver</span>&lt;SigninPayload&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user</span><span class="params">(SigninPayload payload)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> payload.getUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>添加新的顶级解析器 Mutation。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SigninPayload <span class="title function_">signinUser</span><span class="params">(AuthData auth)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userRepository.findByEmail(auth.getEmail());</span><br><span class="line">    <span class="keyword">if</span> (user.getPassword().equals(auth.getPassword())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SigninPayload</span>(user.getId(), user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GraphQLException</span>(<span class="string">&quot;Invalid credentials&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>最后，更新架构构建逻辑GraphQLEndpoint 以包含新的解析器：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> SchemaParser.newParser()</span><br><span class="line">    .file(<span class="string">&quot;schema.graphqls&quot;</span>)</span><br><span class="line">    .resolvers(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Query</span>(linkRepository),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Mutation</span>(linkRepository, userRepository),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">SigninResolver</span>())</span><br><span class="line">    .build()</span><br><span class="line">    .makeExecutableSchema();</span><br></pre></td></tr></table></figure></li>
<li>重新启动Jetty并在GraphiQL 中测试：<br><img src="https://i.loli.net/2019/05/14/5cda601d503bc22376.png"><br>此示例中的标记只是用户标识。实际上，它应该是JWT或类似的。</li>
</ol>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>现在您已经有了对用户进行签名的方法，现在是时候处理对未来请求的身份验证了。执行此操作的常见方法是期望客户端（通常是浏览器）在标头中的每个后续请求成功登录后返回收到的令牌Authorization 。</p>
<ol>
<li>配置GraphiQL 进行身份验证<br>作为服务器开发人员，这对您来说意味着您需要检查每个需要身份验证和&#x2F;或授权的请求的标头值Authorization 。<br>在GraphQL 中，获取此类数据的方式（不是来自查询或突变本身）是通过上下文对象实现的。这是一个传递给在操作执行期间触发的所有解析器的值。<br>在SimpleGraphQLServlet 您的类GraphQLEndpoint 已经延伸提供了这样一个对象，并且其存储在HTTP 请求和响应中的对象。虽然这已经可以使用，但最好将其扩展为更直接地支持您的用例。</li>
</ol>
<ul>
<li>创建一个名为AuthContextextend GraphQLContext的类：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthContext</span> <span class="keyword">extends</span> <span class="title class_">GraphQLContext</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> User user;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthContext</span><span class="params">(User user, Optional&lt;HttpServletRequest&gt; request, Optional&lt;HttpServletResponse&gt; response)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(request, response);</span><br><span class="line">        <span class="built_in">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>覆盖createContext方法GraphQLEndpoint以创建此上下文对象而不是原始对象：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> GraphQLContext <span class="title function_">createContext</span><span class="params">(Optional&lt;HttpServletRequest&gt; request, Optional&lt;HttpServletResponse&gt; response)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> request</span><br><span class="line">        .map(req -&gt; req.getHeader(<span class="string">&quot;Authorization&quot;</span>))</span><br><span class="line">        .filter(id -&gt; !id.isEmpty())</span><br><span class="line">        .map(id -&gt; id.replace(<span class="string">&quot;Bearer &quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">        .map(userRepository::findById)</span><br><span class="line">        .orElse(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthContext</span>(user, request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 此代码将检查Authorization 标头是否存在，如果存在，请修剪Bearer 前缀并使用余数作为id 来获取用户。然后，用户将存储在您创建的自定义上下文中。AuthContext 所有需要它的解析器都可以访问它。</li>
</ul>
<ol start="2">
<li>扩展链接模型</li>
</ol>
<ul>
<li><p>首先修改链接模型以跟踪创建它的用户</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type Link &#123;</span><br><span class="line">    id: ID!</span><br><span class="line">    url: String!</span><br><span class="line">    description: String</span><br><span class="line">    postedBy: User</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Link类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Link</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String description;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Link</span><span class="params">(String url, String description, String userId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>, url, description, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Link</span><span class="params">(String id, String url, String description, String userId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">        <span class="built_in">this</span>.description = description;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于添加了非标量关系Link ，它现在需要一个LinkResolver 类<br>创建LinkResolver 以包含链接操作逻辑（Link只是保存数据）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkResolver</span> <span class="keyword">implements</span> <span class="title class_">GraphQLResolver</span>&lt;Link&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkResolver</span><span class="params">(UserRepository userRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">postedBy</span><span class="params">(Link link)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (link.getUserId() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findById(link.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册新的解析器与SchemaParser<br>更新 GraphQLEndpoint#buildSchema 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> GraphQLSchema <span class="title function_">buildSchema</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SchemaParser.newParser()</span><br><span class="line">                .file(<span class="string">&quot;schema.graphqls&quot;</span>)</span><br><span class="line">                .resolvers(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Query</span>(linkRepository),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Mutation</span>(linkRepository, userRepository),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">SigninResolver</span>(),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">LinkResolver</span>(userRepository))</span><br><span class="line">                .build()</span><br><span class="line">                .makeExecutableSchema();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要更新用于加载和保存链接的逻辑以处理新字段<br>加载并保存userId 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MongoCollection&lt;Document&gt; links;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkRepository</span><span class="params">(MongoCollection&lt;Document&gt; links)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.links = links;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">getAllLinks</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Link&gt; allLinks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Document doc : links.find()) &#123;</span><br><span class="line">            <span class="type">Link</span> <span class="variable">link</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Link</span>(</span><br><span class="line">                    doc.get(<span class="string">&quot;_id&quot;</span>).toString(),</span><br><span class="line">                    doc.getString(<span class="string">&quot;url&quot;</span>),</span><br><span class="line">                    doc.getString(<span class="string">&quot;description&quot;</span>),</span><br><span class="line">                    doc.getString(<span class="string">&quot;postedBy&quot;</span>)</span><br><span class="line">            );</span><br><span class="line">            allLinks.add(link);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allLinks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveLink</span><span class="params">(Link link)</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        doc.append(<span class="string">&quot;url&quot;</span>, link.getUrl());</span><br><span class="line">        doc.append(<span class="string">&quot;description&quot;</span>, link.getDescription());</span><br><span class="line">        doc.append(<span class="string">&quot;postedBy&quot;</span>, link.getUserId());</span><br><span class="line">        links.insertOne(doc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，将当前登录的用户视为创建者<br>更改要插入的createLink 解析程序方法userId 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//The way to inject the context is via DataFetchingEnvironment</span><br><span class="line"> public Link createLink(String url, String description, DataFetchingEnvironment env) &#123;</span><br><span class="line">     AuthContext context = env.getContext();</span><br><span class="line">     Link newLink = new Link(url, description, context.getUser().getId());</span><br><span class="line">     linkRepository.saveLink(newLink);</span><br><span class="line">     return newLink;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试<br><img src="https://i.loli.net/2019/05/14/5cda6929b79e952746.png"><br> 验证测试<br><img src="https://i.loli.net/2019/05/14/5cda692a5ff1591530.png"></p>
</li>
</ul>
<hr>

<h3 id="更多突变"><a href="#更多突变" class="headerlink" title="更多突变"></a>更多突变</h3><h4 id="投票链接"><a href="#投票链接" class="headerlink" title="投票链接"></a>投票链接</h4><p>完成身份验证后，是时候将新功能引入系统 - 投票！用户应该能够投票选择他们喜欢的链接，以便稍后可以通过流行度来排序链接。</p>
<ol>
<li><p>描述新的突变和相关类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type Mutation &#123;</span><br><span class="line">  #the others stay the same</span><br><span class="line">  <span class="title function_">createVote</span><span class="params">(linkId: ID, userId: ID)</span>: Vote</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Vote &#123;</span><br><span class="line">    id: ID!</span><br><span class="line">    createdAt: DateTime!</span><br><span class="line">    user: User!</span><br><span class="line">    link: Link!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">scalar DateTime</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建类似的数据和解析器类<br>Vote 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vote</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZonedDateTime createdAt;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String userId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String linkId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Vote</span><span class="params">(ZonedDateTime createdAt, String userId, String linkId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>, createdAt, userId, linkId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Vote</span><span class="params">(String id, ZonedDateTime createdAt, String userId, String linkId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.createdAt = createdAt;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">        <span class="built_in">this</span>.linkId = linkId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ZonedDateTime <span class="title function_">getCreatedAt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createdAt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLinkId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> linkId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> VoteResolver 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoteResolver</span> <span class="keyword">implements</span> <span class="title class_">GraphQLResolver</span>&lt;Vote&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkRepository linkRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VoteResolver</span><span class="params">(LinkRepository linkRepository, UserRepository userRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.linkRepository = linkRepository;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user</span><span class="params">(Vote vote)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findById(vote.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Link <span class="title function_">link</span><span class="params">(Vote vote)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> linkRepository.findById(vote.getLinkId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>持久性类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoteRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MongoCollection&lt;Document&gt; votes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VoteRepository</span><span class="params">(MongoCollection&lt;Document&gt; votes)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.votes = votes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Vote&gt; <span class="title function_">findByUserId</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        List&lt;Vote&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Document doc : votes.find(eq(<span class="string">&quot;userId&quot;</span>, userId))) &#123;</span><br><span class="line">            list.add(vote(doc));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Vote&gt; <span class="title function_">findByLinkId</span><span class="params">(String linkId)</span> &#123;</span><br><span class="line">        List&lt;Vote&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Document doc : votes.find(eq(<span class="string">&quot;linkId&quot;</span>, linkId))) &#123;</span><br><span class="line">            list.add(vote(doc));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vote <span class="title function_">saveVote</span><span class="params">(Vote vote)</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        doc.append(<span class="string">&quot;userId&quot;</span>, vote.getUserId());</span><br><span class="line">        doc.append(<span class="string">&quot;linkId&quot;</span>, vote.getLinkId());</span><br><span class="line">        doc.append(<span class="string">&quot;createdAt&quot;</span>, Scalars.dateTime.getCoercing().serialize(vote.getCreatedAt()));</span><br><span class="line">        votes.insertOne(doc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vote</span>(</span><br><span class="line">                doc.get(<span class="string">&quot;_id&quot;</span>).toString(),</span><br><span class="line">                vote.getCreatedAt(),</span><br><span class="line">                vote.getUserId(),</span><br><span class="line">                vote.getLinkId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Vote <span class="title function_">vote</span><span class="params">(Document doc)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vote</span>(</span><br><span class="line">                doc.get(<span class="string">&quot;_id&quot;</span>).toString(),</span><br><span class="line">                ZonedDateTime.parse(doc.getString(<span class="string">&quot;createdAt&quot;</span>)),</span><br><span class="line">                doc.getString(<span class="string">&quot;userId&quot;</span>),</span><br><span class="line">                doc.getString(<span class="string">&quot;linkId&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要创建一个新的标量类型来表示DateTime<br>需要一个实例GraphQLScalarType 。有关如何创建这些内容的参考，您可以查看内置类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Scalars</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">GraphQLScalarType</span> <span class="variable">dateTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GraphQLScalarType</span>(<span class="string">&quot;DateTime&quot;</span>, <span class="string">&quot;DataTime scalar&quot;</span>, <span class="keyword">new</span> <span class="title class_">Coercing</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">serialize</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">            <span class="comment">//serialize the ZonedDateTime into string on the way out</span></span><br><span class="line">            <span class="keyword">return</span> ((ZonedDateTime)input).format(DateTimeFormatter.ISO_OFFSET_DATE_TIME);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">parseValue</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> serialize(input);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> ZonedDateTime <span class="title function_">parseLiteral</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">            <span class="comment">//parse the string values coming in</span></span><br><span class="line">            <span class="keyword">if</span> (input <span class="keyword">instanceof</span> StringValue) &#123;</span><br><span class="line">                <span class="keyword">return</span> ZonedDateTime.parse(((StringValue) input).getValue());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>GraphQLEndpoint 需要知道新的存储库，解析器和标量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> VoteRepository voteRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// the rest stays</span></span><br><span class="line">    voteRepository = <span class="keyword">new</span> <span class="title class_">VoteRepository</span>(mongo.getCollection(<span class="string">&quot;votes&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> GraphQLSchema <span class="title function_">buildSchema</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SchemaParser.newParser()</span><br><span class="line">        .file(<span class="string">&quot;schema.graphqls&quot;</span>)</span><br><span class="line">        .resolvers(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Query</span>(linkRepository),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Mutation</span>(linkRepository, userRepository, voteRepository),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SigninResolver</span>(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkResolver</span>(userRepository),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">VoteResolver</span>(linkRepository, userRepository)) <span class="comment">//new resolver</span></span><br><span class="line">        .scalars(Scalars.dateTime) <span class="comment">//register the new scalar</span></span><br><span class="line">        .build()</span><br><span class="line">        .makeExecutableSchema();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建新的突变解析器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Vote <span class="title function_">createVote</span><span class="params">(String linkId, String userId)</span> &#123;</span><br><span class="line">    <span class="type">ZonedDateTime</span> <span class="variable">now</span> <span class="operator">=</span> Instant.now().atZone(ZoneOffset.UTC);</span><br><span class="line">    <span class="keyword">return</span> voteRepository.saveVote(<span class="keyword">new</span> <span class="title class_">Vote</span>(now, userId, linkId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试<br><img src="https://i.loli.net/2019/05/15/5cdb8345c370113435.png"></p>
</li>
</ol>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><h4 id="前提-1"><a href="#前提-1" class="headerlink" title="前提"></a>前提</h4><p>你可能已经看到出现GraphiQL 时出现错误，因此您可能对服务器出现问题时会发生什么事情有一些直觉。在最简单的情况下，如果您错误地输入查询，您将在响应的专用字段中看到错误errors 。</p>
<h4 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h4><p>GraphQL 强调了一致性和可预测性，并且在这种语气中，来自GraphQL 服务器的响应总是具有可预测的结构，包括3个字段：</p>
<ul>
<li>存储操作结果的data 字段。</li>
<li>该errors 字段，保留在执行操作期间累积的所有错误。</li>
<li>具有任意内容的可选extensions 字段，通常是关于响应的元数据。</li>
</ul>
<h4 id="处理方式"><a href="#处理方式" class="headerlink" title="处理方式"></a>处理方式</h4><p>任何GraphQL 服务器都会自动处理语法和验证错误并适当地通知客户端，但解析器函数中遇到的异常通常需要特定于应用程序的处理。使用当前堆栈，可以在几个不同的级别上自定义错误处理。<br>在最高级别，graphql-java-servlet 公开一种方法（称为isClientError ），该方法决定是将消息的消息逐字地发送到客户端，还是由通用服务器错误消息将其隐藏。默认情况下，只会按原样发送语法和验证错误。这是一个合理的默认值，因为异常消息和堆栈跟踪可能会泄露出大量最不可见的公共视图信息。然而，无信息的错误消息（甚至是太多的消息）会对API 的可用性产生严重的负面影响。该方法决定是<strong>将消息的消息逐字</strong>地发送到客户端，还是由通用消息将其隐藏。</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>通过首先询问链接中不存在的字段来检查GraphiQL 中的默认行为address :链接中不存在的字段来检查GraphiQL 中的默认行为。<br><img src="https://i.loli.net/2019/05/15/5cdb85dcd934c17126.png"><br>然后检查特定于应用程序的错误的行为，例如，提供错误的密码signinUser:<br><img src="https://i.loli.net/2019/05/15/5cdb85dccd91622501.png"><br>要允许用户正确清理外发邮件，同时保持其相关性和特定性，请graphql-java-servlet 公开另一个扩展点：GraphQLServlet#filterGraphQLErrors 方法。通过重写此方法，可以在收集的错误发送到客户端之前对其进行清理、过滤、包装或以其他方式转换。<br>一个很好的用例是使用对客户端有用的额外信息来丰富消息。</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><ol>
<li>转发数据获取异常消息，同时仍然隐藏相应的堆栈跟踪，您应该首先创建一个简单的包装类：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnore;</span><br><span class="line"><span class="keyword">import</span> graphql.ExceptionWhileDataFetching;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SanitizedError</span> <span class="keyword">extends</span> <span class="title class_">ExceptionWhileDataFetching</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SanitizedError</span><span class="params">(ExceptionWhileDataFetching inner)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(inner.getException());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">public</span> Throwable <span class="title function_">getException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <small>这个包装器做的不多 - 它只是指示Jackson（JSON 的序列化库）在序列化期间忽略链接的异常。这样，堆栈跟踪将无法到达客户端。</small></li>
<li>然后，通过重写包的所有数据取例外filterGraphQLErrors 的GraphQLEndpoint ：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> List&lt;GraphQLError&gt; <span class="title function_">filterGraphQLErrors</span><span class="params">(List&lt;GraphQLError&gt; errors)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.stream()</span><br><span class="line">            .filter(e -&gt; e <span class="keyword">instanceof</span> ExceptionWhileDataFetching || <span class="built_in">super</span>.isClientError(e))</span><br><span class="line">            .map(e -&gt; e <span class="keyword">instanceof</span> ExceptionWhileDataFetching ? <span class="keyword">new</span> <span class="title class_">SanitizedError</span>((ExceptionWhileDataFetching) e) : e)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <small>这样，除了语法和验证错误之外，数据获取错误将具有发送到客户端的精确消息，但没有粗略的细节。所有其他错误类型仍将隐藏在通用消息后面。</small></li>
</ol>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p><img src="https://i.loli.net/2019/05/15/5cdb87384045b16308.png"><br>对于更低级别的控制，可以自定义执行策略（执行操作的方式，由ExecutionStrategy 接口建模），以及将Java异常转换为GraphQL 错误的覆盖ExecutionStrategy#handleDataFetchingException 方法。<br>要使用自定义执行策略，请将构造函数更改GraphQLEndpoint 为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">GraphQLEndpoint</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(buildSchema(), <span class="keyword">new</span> <span class="title class_">CustomExecutionStrategy</span>());</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<hr>

<h3 id="订阅"><a href="#订阅" class="headerlink" title="订阅"></a>订阅</h3><p>正如你在入门教程中所了解到的，GraphQL 规范定义了一种实时推送式更新机制，称为订阅在响应的专用字段中看到错误。虽然graphql-java 它解析了订阅请求，但是在那里之后就没有再更新了。</p>
<hr>

<h3 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h3><p>正如您在前面的章节中所看到的，查询和突变可以通过参数获取输入。由于参数没有附加固有的语义，并且无论你将它们定义为什么意思，你都可以通过简单地指定用于此目的的参数来轻松实现过滤等常见功能。</p>
<h4 id="将应用此想法将过滤添加到已定义的allLinks查询中"><a href="#将应用此想法将过滤添加到已定义的allLinks查询中" class="headerlink" title="将应用此想法将过滤添加到已定义的allLinks查询中"></a>将应用此想法将过滤添加到已定义的allLinks查询中</h4><ol>
<li><p>在其架构定义中添加一个新参数</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">  allLinks(filter: LinkFilter): [Link]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">input LinkFilter &#123;</span><br><span class="line">  description_contains: String</span><br><span class="line">  url_contains: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这种方法只是一个例子。您也可以使用任何其他格式实现过滤。</p>
</li>
<li><p>创建相应的数据类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonProperty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String descriptionContains;</span><br><span class="line">    <span class="keyword">private</span> String urlContains;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;description_contains&quot;)</span> <span class="comment">//the name must match the schema</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescriptionContains</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> descriptionContains;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDescriptionContains</span><span class="params">(String descriptionContains)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.descriptionContains = descriptionContains;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;url_contains&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrlContains</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> urlContains;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUrlContains</span><span class="params">(String urlContains)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.urlContains = urlContains;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>逻辑需要允许过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">getAllLinks</span><span class="params">(LinkFilter filter)</span> &#123;</span><br><span class="line">    Optional&lt;Bson&gt; mongoFilter = Optional.ofNullable(filter).map(<span class="built_in">this</span>::buildFilter);</span><br><span class="line">    </span><br><span class="line">    List&lt;Link&gt; allLinks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Document doc : mongoFilter.map(links::find).orElseGet(links::find)) &#123;</span><br><span class="line">        allLinks.add(link(doc));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allLinks;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//builds a Bson from a LinkFilter</span></span><br><span class="line"><span class="keyword">private</span> Bson <span class="title function_">buildFilter</span><span class="params">(LinkFilter filter)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">descriptionPattern</span> <span class="operator">=</span> filter.getDescriptionContains();</span><br><span class="line">    <span class="type">String</span> <span class="variable">urlPattern</span> <span class="operator">=</span> filter.getUrlContains();</span><br><span class="line">    <span class="type">Bson</span> <span class="variable">descriptionCondition</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Bson</span> <span class="variable">urlCondition</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (descriptionPattern != <span class="literal">null</span> &amp;&amp; !descriptionPattern.isEmpty()) &#123;</span><br><span class="line">        descriptionCondition = regex(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;.*&quot;</span> + descriptionPattern + <span class="string">&quot;.*&quot;</span>, <span class="string">&quot;i&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (urlPattern != <span class="literal">null</span> &amp;&amp; !urlPattern.isEmpty()) &#123;</span><br><span class="line">        urlCondition = regex(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;.*&quot;</span> + urlPattern + <span class="string">&quot;.*&quot;</span>, <span class="string">&quot;i&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (descriptionCondition != <span class="literal">null</span> &amp;&amp; urlCondition != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> and(descriptionCondition, urlCondition);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> descriptionCondition != <span class="literal">null</span> ? descriptionCondition : urlCondition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新Query以将新参数添加到顶级方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">allLinks</span><span class="params">(LinkFilter filter)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> linkRepository.getAllLinks(filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试<br><img src="https://i.loli.net/2019/05/15/5cdbaceeaf6b187731.png"></p>
</li>
</ol>
<hr>

<h3 id="分页和排序"><a href="#分页和排序" class="headerlink" title="分页和排序"></a>分页和排序</h3><p>随着链接数量的增加，列出所有链接变得不太可行。按理说你应该引入只能请求多个链接并通过结果分页的功能。<br>在本教程中，您将实现一个名为limit-offset 分页的简单分页方法（类似于您可能从SQL 中了解到的）。这种方法不适用于前端的Relay ，因为Relay 需要通过连接的概念进行基于光标的分页。您可以在GraphQL 文档中阅读有关分页的更多信息。</p>
<ol>
<li><p>添加两个新参数以使客户端能够指定它们所需的链接数以及从哪个索引开始</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">  allLinks(filter: LinkFilter, skip: Int = 0, first: Int = 0): [Link]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新存储库方法（LinkRepository#getAllLinks）以获取并使用这些新参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">getAllLinks</span><span class="params">(LinkFilter filter, <span class="type">int</span> skip, <span class="type">int</span> first)</span> &#123;</span><br><span class="line">    Optional&lt;Bson&gt; mongoFilter = Optional.ofNullable(filter).map(<span class="built_in">this</span>::buildFilter);</span><br><span class="line">    </span><br><span class="line">    List&lt;Link&gt; allLinks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    FindIterable&lt;Document&gt; documents = mongoFilter.map(links::find).orElseGet(links::find);</span><br><span class="line">    <span class="keyword">for</span> (Document doc : documents.skip(skip).limit(first)) &#123;</span><br><span class="line">        allLinks.add(link(doc));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allLinks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新类中的顶级方法Query</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">allLinks</span><span class="params">(LinkFilter filter, Number skip, Number first)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> linkRepository.getAllLinks(filter, skip.intValue(), first.intValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <small>两者的参数类型必须是Number 因为graphql-java-tools 有时Integer 会根据上下文尝试填充，有时会填充BigInteger 。</small></p>
</li>
<li><p>测试<br><img src="https://i.loli.net/2019/05/15/5cdbae4ed236667697.png"><br><img src="https://i.loli.net/2019/05/15/5cdbae4ee4c1444497.png"><br><img src="https://i.loli.net/2019/05/15/5cdbae4ed958b39635.png"></p>
</li>
</ol>
<hr>

<h3 id="模式开发的替代方法"><a href="#模式开发的替代方法" class="headerlink" title="模式开发的替代方法"></a>模式开发的替代方法</h3><p>到目前为止，开发的方式称为模式优先，因为始终首先定义模式。这种风格具有重要的好处，在本教程的开头讨论过，它适用于没有遗留代码的新项目。尽管如此，可能已经注意到，在强类和静态类型语言（如Java ）中，它会导致大量重复。例如，重新审视开发类型的方式Link 。<br>在架构中定义：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type Link &#123;</span><br><span class="line">    id: ID!</span><br><span class="line">    url: String!</span><br><span class="line">    description: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 创建了对应的POJO 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Link</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String description;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//constructors, getters and setters</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这两个块都包含完全相同的信息。更糟糕的是，改变一个需要立即改变另一个。这使得重构变得风险和繁琐。另一方面，如果尝试将GraphQL API 引入现有项目，则编写模式实际上意味着重新描述整个现有模型。这既昂贵又容易出错，并且仍然存在重复问题。</p>
<h4 id="代码优先风格"><a href="#代码优先风格" class="headerlink" title="代码优先风格"></a>代码优先风格</h4><p>架构优先样式的常见替代方法（称为代码优先）是从现有模型生成架构。这使架构和模型保持同步，从而简化了重构。它也适用于在现有代码库之上引入GraphQL 的项目。<br>这种方法的缺点是，在编写某些服务器代码之前，架构不存在，从而在客户端和服务器端工作之间引入依赖关系。一种解决方法是使用服务器上的存根来快速生成模式，然后与客户端并行开发真实的服务器代码。<br>Java&#x2F;GraphQL 生态系统催生了一些促进这种开发风格的库。你可以<a target="_blank" rel="noopener" href="https://github.com/graphql-java/awesome-graphql-java#code-first">在这里</a>找到它们。</p>
<h4 id="设置graphql-sqpr"><a href="#设置graphql-sqpr" class="headerlink" title="设置graphql-sqpr"></a>设置graphql-sqpr</h4><ol>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.leangen.graphql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spqr<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过配置如下启用javac 选项maven-compiler-plugin</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>运行，以使新选项生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="使用graphql-spqr-生成模式"><a href="#使用graphql-spqr-生成模式" class="headerlink" title="使用graphql-spqr 生成模式"></a>使用graphql-spqr 生成模式</h4><ol>
<li>修改通过GraphQL 公开的方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Query</span> &#123; <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkRepository linkRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Query</span><span class="params">(LinkRepository linkRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.linkRepository = linkRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GraphQLQuery</span> <span class="comment">//2</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Link&gt; <span class="title function_">allLinks</span><span class="params">(LinkFilter filter,</span></span><br><span class="line"><span class="params">                               <span class="meta">@GraphQLArgument(name = &quot;skip&quot;, defaultValue = &quot;0&quot;)</span> Number skip, //<span class="number">3</span></span></span><br><span class="line"><span class="params">                               <span class="meta">@GraphQLArgument(name = &quot;first&quot;, defaultValue = &quot;0&quot;)</span> Number first)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> linkRepository.getAllLinks(filter, skip.intValue(), first.intValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 有关此代码的一些注意事项：</li>
</ol>
<ul>
<li>GraphQLRootResolver 不再需要实现（也不需要实现graphql-java-tools）。事实上，graphql-spqr 为了确保代码不需要特殊的类，接口或任何修改以便通过GraphQL 公开。</li>
<li>注释完全是可选的，但默认配置将期望它们位于顶层。</li>
<li>默认情况下，方法参数的名称将在架构中使用。使用@GraphQLArgument 是一种更改名称和设置默认值的方法。所有这些都是可行的，没有注释。</li>
</ul>
<ol start="2">
<li>LinkResolver<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkResolver</span> &#123; <span class="comment">//1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    LinkResolver(UserRepository userRepository) &#123;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GraphQLQuery</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">postedBy</span><span class="params">(<span class="meta">@GraphQLContext</span> Link link)</span> &#123; <span class="comment">//2</span></span><br><span class="line">        <span class="keyword">if</span> (link.getUserId() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findById(link.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 特点：</li>
</ol>
<ul>
<li>不再是implements GraphQLResolver<Link> 。</li>
<li>@GraphQLContext 用于将外部方法连接到类型中。此映射在语义上与Link 类包含方法时相同public User postedBy() {…}。以这种方式，可以使逻辑与数据分离，但仍然产生深度嵌套的结构。</li>
</ul>
<ol start="3">
<li>暴露createLink 突变<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GraphQLMutation</span> <span class="comment">//1</span></span><br><span class="line"><span class="keyword">public</span> Link <span class="title function_">createLink</span><span class="params">(String url, String description, <span class="meta">@GraphQLRootContext</span> AuthContext context)</span> &#123; <span class="comment">//2</span></span><br><span class="line">    <span class="type">Link</span> <span class="variable">newLink</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Link</span>(url, description, context.getUser().getId());</span><br><span class="line">    linkRepository.saveLink(newLink);</span><br><span class="line">    <span class="keyword">return</span> newLink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 注意事项：</li>
</ol>
<ul>
<li>通过暴露突变@GraphQLMutation 。</li>
<li>AuthContext 直接注入@GraphQLRootContext 。不再需要DataFetchingEnvironment ，这很好地消除了对逻辑层中特定代码的依赖性graphql-java 。</li>
</ul>
<ol start="4">
<li><p>从类生成模式，请更新GraphQLEndoint#buildSchema </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> GraphQLSchema <span class="title function_">buildSchema</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(linkRepository); <span class="comment">//create or inject the service beans</span></span><br><span class="line">    <span class="type">LinkResolver</span> <span class="variable">linkResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkResolver</span>(userRepository);</span><br><span class="line">    <span class="type">Mutation</span> <span class="variable">mutation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mutation</span>(linkRepository, userRepository, voteRepository);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GraphQLSchemaGenerator</span>()</span><br><span class="line">            .withOperationsFromSingletons(query, linkResolver, mutation) <span class="comment">//register the beans</span></span><br><span class="line">            .generate(); <span class="comment">//done :)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试<br><img src="https://i.loli.net/2019/05/15/5cdbb3163635d37988.png"><br><img src="https://i.loli.net/2019/05/15/5cdbb3160c57e42824.png"><br> 注意的重点：</p>
</li>
</ol>
<ul>
<li>从未明确定义架构（这意味着不必在代码更改时更新它）。</li>
<li>不必将操纵Links 的逻辑分为顶级查询（allLinks 内部Query ），嵌入式查询（postedBy 内部LinkResolver ）和突变（createLink 内部Mutation ）。在链接上运行的所有查询和突变都可以放在一个类中（例如LinkService ），但将它们分开也不是一个障碍。这意味着你的遗留代码和最佳实践可以保持不变。</li>
</ul>
<hr>

<h3 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h3><p>GraphQL 提供了一种简洁明了的方式：类型的方式</p>
<ul>
<li>描述和操纵数据</li>
<li>准确地获取并且仅获取所需的数据</li>
<li>收到可预测的结果。</li>
</ul>
<p>在整个教程中，已经学会了如何在自己的项目中利用这些优势，但仍有许多领域需要您自己探索。如何处理动态数据结构？如何防范恶意查询？缓存等难以理解的主题。</p>
<p>请记住，GraphQL 是一种新兴技术，特别是在Java 的生态系统中。版本的变化、想法和最佳实践的发展和转变，因此请务必密切关注本教程，因为它可能会偶尔更新，甚至可能会被完全重写，以保持相关性。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/GraphQL/" rel="tag"># GraphQL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/JS%20%E4%B8%AD%E7%9A%84var%E3%80%81let%E5%92%8Cconst%E7%9A%84%E5%8C%BA%E5%88%AB%E5%92%8C%E7%9B%B8%E5%90%8C/" rel="prev" title="JS 中的var、let和const的区别和相同">
      <i class="fa fa-chevron-left"></i> JS 中的var、let和const的区别和相同
    </a></div>
      <div class="post-nav-item">
    <a href="/Zookeeper-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" rel="next" title="Zookeeper-快速入门">
      Zookeeper-快速入门 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-number">1.</span> <span class="nav-text">示例代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E6%8F%90"><span class="nav-number">2.1.</span> <span class="nav-text">前提</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GraphQL"><span class="nav-number">2.2.</span> <span class="nav-text">GraphQL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-number">2.3.</span> <span class="nav-text">设计原则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Boot-%E5%BC%80%E5%8F%91"><span class="nav-number">3.</span> <span class="nav-text">Spring Boot 开发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E6%A0%88%E6%95%99%E7%A8%8B"><span class="nav-number">4.</span> <span class="nav-text">全栈教程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="nav-number">5.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A5%E9%97%A8"><span class="nav-number">6.</span> <span class="nav-text">入门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">7.</span> <span class="nav-text">一个简单的查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AA%81%E5%8F%98"><span class="nav-number">8.</span> <span class="nav-text">突变</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E5%99%A8"><span class="nav-number">8.1.</span> <span class="nav-text">连接器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81"><span class="nav-number">9.</span> <span class="nav-text">认证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="nav-number">9.1.</span> <span class="nav-text">创建用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95"><span class="nav-number">9.2.</span> <span class="nav-text">登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-number">9.3.</span> <span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A%E7%AA%81%E5%8F%98"><span class="nav-number">10.</span> <span class="nav-text">更多突变</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8A%95%E7%A5%A8%E9%93%BE%E6%8E%A5"><span class="nav-number">10.1.</span> <span class="nav-text">投票链接</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">11.</span> <span class="nav-text">异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E6%8F%90-1"><span class="nav-number">11.1.</span> <span class="nav-text">前提</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%8D%E5%BA%94"><span class="nav-number">11.2.</span> <span class="nav-text">响应</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="nav-number">11.3.</span> <span class="nav-text">处理方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">11.4.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3"><span class="nav-number">11.5.</span> <span class="nav-text">解决</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">11.6.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E9%98%85"><span class="nav-number">12.</span> <span class="nav-text">订阅</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4"><span class="nav-number">13.</span> <span class="nav-text">过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86%E5%BA%94%E7%94%A8%E6%AD%A4%E6%83%B3%E6%B3%95%E5%B0%86%E8%BF%87%E6%BB%A4%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%B7%B2%E5%AE%9A%E4%B9%89%E7%9A%84allLinks%E6%9F%A5%E8%AF%A2%E4%B8%AD"><span class="nav-number">13.1.</span> <span class="nav-text">将应用此想法将过滤添加到已定义的allLinks查询中</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E5%92%8C%E6%8E%92%E5%BA%8F"><span class="nav-number">14.</span> <span class="nav-text">分页和排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8F%E5%BC%80%E5%8F%91%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%B3%95"><span class="nav-number">15.</span> <span class="nav-text">模式开发的替代方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%85%88%E9%A3%8E%E6%A0%BC"><span class="nav-number">15.1.</span> <span class="nav-text">代码优先风格</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEgraphql-sqpr"><span class="nav-number">15.2.</span> <span class="nav-text">设置graphql-sqpr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8graphql-spqr-%E7%94%9F%E6%88%90%E6%A8%A1%E5%BC%8F"><span class="nav-number">15.3.</span> <span class="nav-text">使用graphql-spqr 生成模式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%91%98%E8%A6%81"><span class="nav-number">16.</span> <span class="nav-text">摘要</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="vgbhfive"
      src="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <p class="site-author-name" itemprop="name">vgbhfive</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/vgbhfive" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;vgbhfive" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:vgbhfive@foxmail.com" title="E-Mail → mailto:vgbhfive@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/5655843279" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;5655843279" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">陕ICP20002937号 </a>
  </div>

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">vgbhfive</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
