<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="G-QBK8PCQC9B">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.vgbhfive.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="简介Nginx 是一个web 服务器和方向代理服务器，用于HTTP、HTTPS、SMTP、POP3 和IMAP 协议。Nginx 是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru 站点开发的，第一个公开版本0.1.0 发布于2004 年10 月4 日。 Nginx 使用可扩展的事件驱动架构，而不是更传统的过程驱动架构。Nginx 开发的目标是实现10倍以上的性能，优化服务器资源的使用，">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx-快速入门和提高">
<meta property="og:url" content="https://blog.vgbhfive.cn/Nginx-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%92%8C%E6%8F%90%E9%AB%98/index.html">
<meta property="og:site_name" content="Vgbhfive&#39;s Blog">
<meta property="og:description" content="简介Nginx 是一个web 服务器和方向代理服务器，用于HTTP、HTTPS、SMTP、POP3 和IMAP 协议。Nginx 是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru 站点开发的，第一个公开版本0.1.0 发布于2004 年10 月4 日。 Nginx 使用可扩展的事件驱动架构，而不是更传统的过程驱动架构。Nginx 开发的目标是实现10倍以上的性能，优化服务器资源的使用，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2019/08/13/n8OyjSXCel73hUF.jpg">
<meta property="og:image" content="https://i.loli.net/2019/08/12/j5veMcTi4LmabJh.jpg">
<meta property="og:image" content="https://i.loli.net/2019/08/12/6NXAjKihcJwlvE1.jpg">
<meta property="og:image" content="https://i.loli.net/2019/08/12/76sELBJUWydzrCK.jpg">
<meta property="og:image" content="https://i.loli.net/2019/08/12/5Xi6jMCghAds9Gv.jpg">
<meta property="article:published_time" content="2019-07-08T00:59:47.000Z">
<meta property="article:modified_time" content="2020-04-16T07:50:20.000Z">
<meta property="article:author" content="vgbhfive">
<meta property="article:tag" content="Nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2019/08/13/n8OyjSXCel73hUF.jpg">

<link rel="canonical" href="https://blog.vgbhfive.cn/Nginx-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%92%8C%E6%8F%90%E9%AB%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Nginx-快速入门和提高 | Vgbhfive's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Vgbhfive's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Vgbhfive's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-pictures">

    <a href="/pictures/" rel="section"><i class="fa fa-th fa-fw"></i>Pictures</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.vgbhfive.cn/Nginx-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%92%8C%E6%8F%90%E9%AB%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
      <meta itemprop="name" content="vgbhfive">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Vgbhfive's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx-快速入门和提高
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-08 08:59:47" itemprop="dateCreated datePublished" datetime="2019-07-08T08:59:47+08:00">2019-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-16 15:50:20" itemprop="dateModified" datetime="2020-04-16T15:50:20+08:00">2020-04-16</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Nginx 是一个web 服务器和方向代理服务器，用于HTTP、HTTPS、SMTP、POP3 和IMAP 协议。<br>Nginx 是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru 站点开发的，第一个公开版本0.1.0 发布于2004 年10 月4 日。</p>
<p>Nginx 使用可扩展的事件驱动架构，而不是更传统的过程驱动架构。<br>Nginx 开发的目标是实现10倍以上的性能，优化服务器资源的使用，同时也能够扩展和支持网站的动态增长。 </p>
<p>因此，Nginx 成为最知名的模块化、事件驱动、异步、单线程Web 服务器和Web 代理之一。</p>
<span id="more"></span>

<h4 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h4><ol>
<li><p>下载Nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.17.0.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install pcre-devel</span><br><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压下载目录，进入到解压目录中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装默认位置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>更快。单次请求会得到更快的响应，并且在高并发环境下，Nginx 比其他Web 服务器有更快的响应。</li>
<li>高扩展性。</li>
<li>高可靠性。Nginx 的可靠性来自于其核心框架代码的优秀设计，模块设计的简单性。</li>
<li>低内存消耗。理论上，Nginx 支持的并发连接上限取决于内存，10万远未封顶。</li>
<li>热部署。Master 进程与Worker 进程的分离设计，使得Nginx 能够提供热部署功能。</li>
<li>BSD 许可协议。</li>
</ul>
<h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><p>常用命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop      <span class="comment"># 快速关闭Nginx，可能不保存相关信息，并迅速终止web服务。</span></span><br><span class="line">nginx -s quit      <span class="comment"># 平稳关闭Nginx，保存相关信息，有安排的结束web服务。</span></span><br><span class="line">nginx -s reload    <span class="comment"># 因改变了Nginx相关配置，需要重新加载配置而重载。</span></span><br><span class="line">nginx -s reopen    <span class="comment"># 重新打开日志文件。</span></span><br><span class="line">nginx -c filename  <span class="comment"># 为 Nginx 指定一个配置文件，来代替缺省的。</span></span><br><span class="line">nginx -t           <span class="comment"># 不运行，而仅仅测试配置文件。nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件。</span></span><br><span class="line">nginx -v           <span class="comment"># 显示 nginx 的版本。</span></span><br><span class="line">nginx -V           <span class="comment"># 显示 nginx 的版本，编译器版本和配置参数。</span></span><br></pre></td></tr></table></figure>

<h4 id="目录建议"><a href="#目录建议" class="headerlink" title="目录建议"></a>目录建议</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$dir/wwwroot/                           - 网站根目录，以域名为文件夹名称</span><br><span class="line">    ./vgbhfive.cn/</span><br><span class="line">    ./static.vgbhfive.cn/</span><br><span class="line"></span><br><span class="line">$dir/src/                               - 安装源包</span><br><span class="line"></span><br><span class="line">$dir/local/nginx/                       - nginx相关根目录</span><br><span class="line">    ./conf/                             - 配置文件</span><br><span class="line">        ./nginx.conf                    - 配置主入口</span><br><span class="line">        ./inc                           - 通用配置</span><br><span class="line">        ./vhost/                        - 各站点的配置，以 `域名.conf` 命名</span><br><span class="line">            ./vgbhfive.cn.conf</span><br><span class="line">            ./static.vgbhfive.cn.conf</span><br><span class="line"></span><br><span class="line">    ./1.11.1/                           - 各个版本的nginx</span><br><span class="line">    ./1.11.2/</span><br><span class="line"></span><br><span class="line">$dir/logs/                              - 日志相关目录，内以 `域名.type.log` 命名</span><br><span class="line">        ./last/                         - 最新的日志</span><br><span class="line">            ./vgbhfive.cn.error.log</span><br><span class="line">            ./vgbhfive.cn.access.log</span><br><span class="line">        ./back/                         - 天级备份日志</span><br><span class="line">            ./20190808/</span><br></pre></td></tr></table></figure>

<hr>

<h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><h4 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h4><ul>
<li>静态代理<br> Nginx 擅长处理静态文件，是非常好的图片、文件服务器。把所有的静态资源的放到nginx 上，可以使应用动静分离，性能更好。</li>
<li>负载均衡<br> Nginx 通过反向代理可以实现服务的负载均衡，避免了服务器单节点故障，把请求按照一定的策略转发到不同的服务器上，达到负载的效果。<br> 常用的负载均衡策略：</li>
<li>轮询<br>  将请求按顺序轮流地分配到后端服务器上，它均衡地对待后端的每一台服务器，而不关心服务器实际的连接数和当前的系统负载。</li>
<li>加权轮询<br>  不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。给配置高、负载低的机器配置更高的权重，让其处理更多的请。而配置低、负载高的机器，给其分配较低的权重，降低其系统负载，加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。</li>
<li>ip_hash(源地址哈希法)<br>  根据获取客户端的IP 地址，通过哈希函数计算得到一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客户端要访问服务器的序号。采用源地址哈希法进行负载均衡，同一IP地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问。</li>
<li>随机<br>  通过系统的随机算法，根据后端服务器的列表大小值来随机选取其中的一台服务器进行访问。</li>
<li>least_conn(最小连接法)<br>  由于后端服务器的配置不尽相同，对于请求的处理有快有慢，最小连接数法根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器。</li>
<li>限流<br> Nginx 的限流模块，是基于<strong>漏桶算法</strong>实现的，在高并发的场景下非常实用。 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $binary_remote_addr zone=mylimit:10m rate=100r/s</span><br><span class="line">location /server2 &#123;</span><br><span class="line">	limit_req zone=mylimit burst=20 nodelay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 配置参数：</li>
<li>limit_req_zone 定义在Http 块中，$binary_remote_addr 表示保存客户端IP 地址的二进制形式。</li>
<li>Zone 定义IP 状态及URL 访问频率的共享内存区域。zone&#x3D;keyword 标识区域的名字、以及冒号后面跟区域大小。</li>
<li>Rate 定义最大请求速率。</li>
</ul>
<p> 设置限流：</p>
<ul>
<li>burst 排队大小，nodelay 不限制单个请求间的事件。</li>
<li>缓存</li>
<li>浏览器缓存，静态资源缓存用expire</li>
<li>代理层缓存</li>
<li>黑白名单</li>
<li>不限流白名单  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$remote_addr</span> !~ ^(100.110.15.16|100.110.15.17|100.110.15.18|127.0.0.1)) &#123; <span class="comment"># $remote_addr 和$http_x_foeward_for 记录客户端的ip 地址</span></span><br><span class="line">  rewrite ^.*$ /maintence.php last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>黑名单  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	deny 10.52.119.21;</span><br><span class="line">	deny 122..12.1.0/24;</span><br><span class="line">	allow 10.1.1.0/16;</span><br><span class="line">	allow 1001:0db8::/32;</span><br><span class="line">	deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="Nginx-配置"><a href="#Nginx-配置" class="headerlink" title="Nginx 配置"></a>Nginx 配置</h4><h5 id="默认配置-nginx-conf"><a href="#默认配置-nginx-conf" class="headerlink" title="默认配置 - nginx.conf"></a>默认配置 - nginx.conf</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局块</span></span><br><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># events 块</span></span><br><span class="line">events &#123;</span><br><span class="line">	use epoll;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># http 块</span></span><br><span class="line">http &#123;</span><br><span class="line">	<span class="comment"># http 全局块</span></span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># server 块</span></span><br><span class="line">    server &#123;</span><br><span class="line">    	<span class="comment"># server 全局块</span></span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># location 块</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    root           html;</span></span><br><span class="line">        <span class="comment">#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">        <span class="comment">#    fastcgi_index  index.php;</span></span><br><span class="line">        <span class="comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">        <span class="comment">#    include        fastcgi_params;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">        <span class="comment">#    deny  all;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># http 全局块</span></span><br><span class="line">    <span class="comment"># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       8000;</span></span><br><span class="line">    <span class="comment">#    listen       somename:8080;</span></span><br><span class="line">    <span class="comment">#    server_name  somename  alias  another.alias;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># HTTPS server</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       443 ssl;</span></span><br><span class="line">    <span class="comment">#    server_name  localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_certificate      cert.pem;</span></span><br><span class="line">    <span class="comment">#    ssl_certificate_key  cert.key;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_session_cache    shared:SSL:1m;</span></span><br><span class="line">    <span class="comment">#    ssl_session_timeout  5m;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class="line">    <span class="comment">#    ssl_prefer_server_ciphers  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 主要包含内容：</p>
<ul>
<li>全局块：</li>
<li>events 块：</li>
<li>http 块：</li>
<li>server 块：</li>
<li>location 块：</li>
</ul>
<h5 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########### 每个指令必须有分号结束。#################</span></span><br><span class="line"><span class="comment">#user administrator administrators;  #配置用户或者组，默认为nobody nobody。</span></span><br><span class="line"><span class="comment">#worker_processes 2;  #允许生成的进程数，默认为1</span></span><br><span class="line"><span class="comment">#pid /nginx/pid/nginx.pid;   #指定nginx进程运行文件存放地址</span></span><br><span class="line">error_log <span class="built_in">log</span>/error.log debug;  <span class="comment">#制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg</span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    accept_mutex on;   <span class="comment">#设置网路连接序列化，防止惊群现象发生，默认为on</span></span><br><span class="line">    multi_accept on;  <span class="comment">#设置一个进程是否同时接受多个网络连接，默认为off</span></span><br><span class="line">    <span class="comment">#use epoll;      #事件驱动模型，select|poll|kqueue|epoll|resig|/dev/poll|eventport</span></span><br><span class="line">    worker_connections  1024;    <span class="comment">#最大连接数，默认为512</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;   <span class="comment">#文件扩展名与文件类型映射表</span></span><br><span class="line">    default_type  application/octet-stream; <span class="comment">#默认文件类型，默认为text/plain</span></span><br><span class="line">    <span class="comment">#access_log off; #取消服务日志    </span></span><br><span class="line">    log_format myFormat <span class="string">&#x27;$remote_addr–$remote_user [$time_local] $request $status $body_bytes_sent $http_referer $http_user_agent $http_x_forwarded_for&#x27;</span>; <span class="comment">#自定义格式</span></span><br><span class="line">    access_log <span class="built_in">log</span>/access.log myFormat;  <span class="comment">#combined为日志格式的默认值</span></span><br><span class="line">    sendfile on;   <span class="comment">#允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。</span></span><br><span class="line">    sendfile_max_chunk 100k;  <span class="comment">#每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span></span><br><span class="line">    keepalive_timeout 65;  <span class="comment">#连接超时时间，默认为75s，可以在http，server，location块。</span></span><br><span class="line"></span><br><span class="line">    upstream mysvr &#123;   </span><br><span class="line">      server 127.0.0.1:7878;</span><br><span class="line">      server 192.168.10.121:3333 backup;  <span class="comment">#热备</span></span><br><span class="line">    &#125;</span><br><span class="line">    error_page 404 https://www.baidu.com; <span class="comment">#错误页</span></span><br><span class="line">    server &#123;</span><br><span class="line">        keepalive_requests 120; <span class="comment">#单连接请求上限次数。</span></span><br><span class="line">        listen       4545;   	<span class="comment">#监听端口</span></span><br><span class="line">        server_name  127.0.0.1;   <span class="comment">#监听地址       </span></span><br><span class="line">        location  ~*^.+$ &#123;       <span class="comment">#请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。</span></span><br><span class="line">           <span class="comment">#root path;  #根目录</span></span><br><span class="line">           <span class="comment">#index vv.txt;  #设置默认页</span></span><br><span class="line">           proxy_pass  http://mysvr;  <span class="comment">#请求转向mysvr 定义的服务器列表</span></span><br><span class="line">           deny 127.0.0.1;  <span class="comment">#拒绝的ip</span></span><br><span class="line">           allow 172.18.5.54; <span class="comment">#允许的ip           </span></span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常见配置项：</p>
<ul>
<li>$remote_addr 与 $http_x_forwarded_for: 用以记录客户端的ip地址。</li>
<li>$remote_user: 用来记录客户端用户名称。</li>
<li>$time_local: 用来记录访问时间与时区。</li>
<li>$request: 用来记录请求的url与http协议。</li>
<li>$status: 用来记录请求状态；成功是200。</li>
<li>$body_bytes_s ent: 记录发送给客户端文件主体内容大小。</li>
<li>$http_referer: 用来记录从那个页面链接访问过来的。</li>
<li>$http_user_agent: 记录客户端浏览器的相关信息。</li>
<li>每个指令必须以分号结束。</li>
</ul>
<p><small>惊群现象：一个网络连接到来，多个正在睡眠的进程被同时叫醒，但只有一个进程能获得链接，这样会影响系统性能。</small></p>
<h4 id="事件模型"><a href="#事件模型" class="headerlink" title="事件模型"></a>事件模型</h4><ul>
<li>epoll</li>
<li>poll </li>
<li>select </li>
<li>kqueue </li>
<li>rtsig</li>
<li>&#x2F;dev&#x2F;poll&#x2F; </li>
<li>eventport</li>
</ul>
<h4 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h4><p><img src="https://i.loli.net/2019/08/13/n8OyjSXCel73hUF.jpg" alt="1.jpg"><br>主要包含以下内容：</p>
<ul>
<li>主进程</li>
<li>工作进程</li>
<li>模块化设计</li>
<li>事件驱动模型</li>
<li>代理设计</li>
</ul>
<hr>

<h3 id="提高"><a href="#提高" class="headerlink" title="提高"></a>提高</h3><h4 id="模块化设计"><a href="#模块化设计" class="headerlink" title="模块化设计"></a>模块化设计</h4><p>高度模块化的设计是Nginx 的架构基础。Nginx 服务器被分解为多个模块，每个模块就是一个功能模块，只负责自身的功能，模块之间遵循“高内聚，低耦合”的原则。<br><img src="https://i.loli.net/2019/08/12/j5veMcTi4LmabJh.jpg" alt="1.jpg"></p>
<ul>
<li>核心模块<br> 核心模块是Nginx 服务器正常运行必不可少的模块，提供错误日志、配置文件解析、事件驱动机制、进程管理等核心功能。</li>
<li>标准HTTP 模块<br> 标准HTP 模块提供HTTP 协议解析相关的功能，如：端口配置、网页编码配置、HTTP 响应头设置等。</li>
<li>可选HTTP 模块<br> 可选HTTP 模块主要用于扩展标准的HTTP 模块，让Nginx 能处理一些特殊的服务，如：Flash多媒体传输、解析GeoIP 请求、SSL 支持等。</li>
<li>邮件服务模块<br> 邮件服务模块主要用于支持Nginx 的邮件服务，包括对POP3 协议、IMAP 协议、SMTP 协议的支持。</li>
<li>第三方模块<br> 第三方模块是为了扩展Nginx 服务器应用，完成开发者自定义的功能，如：Json 支持、Lus 支持等。</li>
</ul>
<h4 id="请求方式"><a href="#请求方式" class="headerlink" title="请求方式"></a>请求方式</h4><p>Nginx 是一个高性能的Web 服务器，能够同时处理大量的并发请求。它结合多线程机制和异步机制，异步机制使用的是异步非阻塞方式。</p>
<ol>
<li><p>多线程<br>服务器每当收到一个客户端时，就有服务器<strong>主进程(Master Process)</strong> 生成一个<strong>子线程(Worker Process)</strong> 出来和客户端建立连接进行交互，直到连接断开，该子进程就结束了。<br>使用线程的好处在于各个进程之间相互独立，不需要加锁，减少了因为锁对性能造成影响，同时降低编程的复杂度，降低开发成本。<br>其次，采用独立的进程，可以让进程互相之间不会影响，如果一个进程发生异常退出时，其他进程正常工作，Master 进程则很快启动新的Worker 进程，确保服务不中断，将风险降到最低。<br><br>缺点是操作系统生成一个子线程需要进行内存复制等操作，在资源和时间上会产生一定的开销，当有大量的请求时，会导致系统性能下降。</p>
</li>
<li><p>异步非阻塞<br>每个工作进程使用<strong>异步非阻塞方式</strong>，可以处理多个客户端请求。当某个工作进程接收到客户端的请求之后，调用IO 进行处理，如果不能立即得到结果，就去处理其他请求（非阻塞）。<br>而客户端在此期间也无需等待，可以去处理其他事情（异步）。<br>当IO 返回时，就会通知此工作进程，该进程得到通知，暂时挂起当前处理的事务去响应客户端请求。</p>
</li>
</ol>
<h4 id="事件驱动"><a href="#事件驱动" class="headerlink" title="事件驱动"></a>事件驱动</h4><p>在Nginx 的异步非阻塞机制中，工作进程在调用IO 之后，就去处理其他的请求，当IO 调用返回后，会通知该工作进程。对于这样的系统调用，主要使用Nginx 服务器的<strong>事件驱动模型</strong>来实现。</p>
<p><img src="https://i.loli.net/2019/08/12/6NXAjKihcJwlvE1.jpg" alt="2.jpg"><br>Nginx 的事件驱动模型是由事件收集器、事件发送器和事件处理器三部分组成。其中，事件收集器负责收集Worker 进程的各种IO 请求，事件发送器负责将IO 事件发送到时间处理器，而事件处理器负责各种事件的响应工作。<br>事件发送器将每个请求放入一个待处理的列表，使用非阻塞IO 方式调用“事件处理器”l来处理该请求。其处理方式被称为<strong>多路IO复用</strong>方法。<br>常见的包括一下三种：</p>
<ul>
<li>select 模型</li>
<li>poll 模型</li>
<li>epoll 模型</li>
</ul>
<h4 id="设计架构"><a href="#设计架构" class="headerlink" title="设计架构"></a>设计架构</h4><p>Nginx 服务器使用Master&#x2F;Worker 多进程模式。<br><img src="https://i.loli.net/2019/08/12/76sELBJUWydzrCK.jpg" alt="3.jpg"><br>多线程启动和执行的流程如下：主程序Master process 启动后，通过一个for 循环来接收和处理外部信号；主进程通过fork() 函数产生子进程，每个子进程执行一个for 循环来实现Nginx 服务器对事件的接收和处理。<br><br>一般<strong>推荐Worker 进程数与CPU 内核数一致</strong>，这样一来不存在大量的子进程生成和管理任务，避免了进程之间竞争CPU 资源和进程切换的开销。<br>而且Nginx 为了更好的利用多核特性，提供了CPU 亲缘性的绑定选项，我们可以将某一个进程绑定在某一个核上，这样就不会因为进程的切换带来cache 的失效。<br><br>对于每个请求，有且只有一个工作进程对其处理。首先，每个Worker 进程都是从Master 进程fork 过来，在Master 进程里面，先建立好需要listen 的socket（listenfd）之后，然后再fork 出多个Worker 进程。<br>所有Worker 进程的listenfd 会在新连接到来时变得可读，为保证只有一个进程处理该连接，所有Worker 进程在注册 listenfd 读事件前抢 <strong>accept_mutex</strong>，抢到互斥锁的那个进程注册 listenfd 读事件，在读事件里调用 accept 接受该连接。<br>当一个Worker 进程在accept 这个连接之后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后才断开连接，这样一个完整的请求就是这样的。<br><br>最后可以看到，一个请求，完全由Worker 进程来处理，而且只在一个Worker 进程中处理。<br><img src="https://i.loli.net/2019/08/12/5Xi6jMCghAds9Gv.jpg" alt="4.jpg"></p>
<h4 id="代理设计"><a href="#代理设计" class="headerlink" title="代理设计"></a>代理设计</h4><p>在用户的视野里，代理服务器便是目标服务器。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.yourdomain.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        <span class="comment"># 后端的 Web Server, 即真实服务器</span></span><br><span class="line">        proxy_pass http://www.your-real-domain.com;</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 定义 header 变量, 记录使用者的 IP</span></span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$http_x_forwarded_proto</span>;</span><br><span class="line">        proxy_max_temp_file_size 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h3 id="面试"><a href="#面试" class="headerlink" title="面试"></a>面试</h3><ol>
<li><p>Nginx 如何处理HTTP 请求<br>Nginx 使用<a target="_blank" rel="noopener" href="https://blog.csdn.net/pistolove/article/details/53152708">反应器模式</a>。主事件循环等待操作系统发出准备事件的信号，这样数据就可以从套接字读取，在该实例中读取到缓冲区并进行处理。单个线程可以提供数万个并发连接。</p>
</li>
<li><p>Nginx 中，如何使用未定义的服务器名称来阻止处理请求<br>只需要将请求删除的服务器定义为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name &quot; &quot;;</span><br><span class="line">return 444;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这样，服务器被保留一个空字符串，它将在没有”主机”头字段的情况下进行匹配，而一个特殊的Nginx 的非标准代码444 被返回，从而终止连接。</p>
</li>
<li><p>反向代理服务器的优点<br>反向代理服务器可以隐藏源服务器的特征和存在。这对于安全方面来说是很好的，特别是使用Web 托管服务时。</p>
</li>
<li><p>Nginx 服务器的最佳用途<br>Nginx 服务器的最佳用法是在网络上部署动态HTTP 内容，使用SCGI、WSGI 应用程序服务器、用于脚本的FastCGI处理程序。还可以作为负载均衡器。</p>
</li>
<li><p>解释一下Nginx 服务器中的Master 和Worker 分别是什么<br>Master 进程：读取请求、评估配置和维持运行<br>Worker 进程：处理请求</p>
</li>
<li><p>解释是否有可能将Ngix 服务器的错误转换为502、503错误<br>502 &#x3D; 错误网关 503 &#x3D; 服务器超载<br>有可能，但是需要确保fastcgi_intercept_errors 被设置为ON ，并使用错误页面指令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Location / &#123;</span><br><span class="line">fastcgi_pass 127.0.01:9001;</span><br><span class="line">fastcgi_intercept_errors on;</span><br><span class="line">error_page 502 =503/error_page.html;</span><br><span class="line">#…</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>解释如何在URL 中保留双斜线<br>要在URL中保留双斜线，就必须使用merge_slashes_off;<br>语法:merge_slashes [on&#x2F;off]<br>默认值: merge_slashes on<br>环境: http，server</p>
</li>
<li><p>ngx_http_upstream_module 的作用是什么<br>ngx_http_upstream_module 用于定义可通过FastCGI 传递、Proxy 传递、UWSGI 传递、Memcached 传递和SCGI 传递指令来引用的服务器组。</p>
</li>
<li><p>C10K 问题<br>C10K 问题是指无法同时处理大量客户端(10,000)的网络套接字。</p>
</li>
<li><p>陈述stub_status 和sub_filter 指令的作用是什么<br>Stub_status 指令：该指令用于了解Nginx 当前状态的当前状态。如当前的活动连接，接受和处理当前读&#x2F;写&#x2F;等待连接的总数。<br>Sub_filter 指令：它用于搜索和替换响应中的内容，并快速修复陈旧的数据。</p>
</li>
<li><p>解释Nginx 是否支持将请求压缩到上游<br>可以使用Nginx 模块gunzip 将请求压缩到上游。<br>gunzip 模块是一个过滤器，它可以对不支持”gzip” 编码方法的客户机或服务器使用“内容编码:gzip ”来解压缩响应。</p>
</li>
<li><p>如何在Nginx 中获得当前时间<br>要获得Nginx 的当前时间，必须使用SSI 模块、$date_gmt 和$date_local 的变量。<br>Proxy_set_header THE-TIME $date_gmt;</p>
</li>
<li><p>常见502 报错的原因<br>配置错误、资源耗尽、</p>
</li>
</ol>
<hr>

<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><h4 id="HTTP-反向代理"><a href="#HTTP-反向代理" class="headerlink" title="HTTP 反向代理"></a>HTTP 反向代理</h4><h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#运行nginx进程的账户</span></span><br><span class="line">user www;</span><br><span class="line"></span><br><span class="line">worker_process 1;</span><br><span class="line">error_log /var/log/nginx/error.log</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events&#123;</span><br><span class="line">	accept_mutex on;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http&#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    <span class="comment"># 开启传输文件</span></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment"># 持续连接时间</span></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    gzip  on;</span><br><span class="line"></span><br><span class="line">    index   index.html index.htm;</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    include /etc/nginx/sites-enabled/*;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义上游服务器列表组</span></span><br><span class="line">    upstream web1 &#123;</span><br><span class="line">        server 127.0.0.1:111 weight=1;</span><br><span class="line">        server 127.0.0.1:222 weight=1;</span><br><span class="line">    &#125;</span><br><span class="line">    upstream web2 &#123;</span><br><span class="line">        server 127.0.0.2:111 weight=1;</span><br><span class="line">        server 127.0.0.2:222 weight=6;</span><br><span class="line">        server 127.0.0.2:333 weight=7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#定义一个服务器，其监听80端口，配置的域名是www.company.com</span></span><br><span class="line">    server&#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        <span class="comment"># using www  domain to access the main website</span></span><br><span class="line">        server_name www.company.com;</span><br><span class="line">        access_log  /var/log/nginx/www.log</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root /home/website_root;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#定义第二个服务器，其同样监听80端口，但是匹配域名是web.company.com</span></span><br><span class="line">    server&#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        <span class="comment"># using web sub domain to access</span></span><br><span class="line">        server_name web.company.com;</span><br><span class="line">        access_log  /var/log/nginx/web_access.log</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root /home/web2_root;</span><br><span class="line">            proxy_pass http://127.0.0.1:8080/web/;</span><br><span class="line">            proxy_read_timeout 300;</span><br><span class="line">            proxy_connect_timeout 300;</span><br><span class="line">            proxy_redirect     off;</span><br><span class="line"></span><br><span class="line">            proxy_set_header   X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">            proxy_set_header   Host              <span class="variable">$http_host</span>;</span><br><span class="line">            proxy_set_header   X-Real-IP         <span class="variable">$remote_addr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#定义第三个服务器，其同样监听80端口，但是匹配域名是web1.company.com，并把请求转发到web1上游服务</span></span><br><span class="line">    server&#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        <span class="comment"># using web1 sub domain to access</span></span><br><span class="line">        server_name web1.company.com;</span><br><span class="line">        access_log  /var/log/nginx/web1_access.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root /home/web1_root;</span><br><span class="line">            proxy_pass http://web1;</span><br><span class="line">            proxy_read_timeout 300;</span><br><span class="line">            proxy_connect_timeout 300;</span><br><span class="line">            proxy_redirect     off;</span><br><span class="line"></span><br><span class="line">            proxy_set_header   X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">            proxy_set_header   Host              <span class="variable">$http_host</span>;</span><br><span class="line">            proxy_set_header   X-Real-IP         <span class="variable">$remote_addr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#定义第三个服务器，其同样监听80端口，但是匹配域名是web2.company.com，并把请求转发到web2上游服务</span></span><br><span class="line">    server&#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        <span class="comment"># using web2 sub domain to access</span></span><br><span class="line">        server_name web2.company.com;</span><br><span class="line">        access_log  /var/log/nginx/web2_access.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root /home/web2_root;</span><br><span class="line">            proxy_pass http://web2; <span class="comment"># 跳转网址</span></span><br><span class="line">            proxy_read_timeout 300;</span><br><span class="line">            proxy_connect_timeout 300;</span><br><span class="line">            proxy_redirect     off;</span><br><span class="line"></span><br><span class="line">            proxy_set_header   X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">            proxy_set_header   Host              <span class="variable">$http_host</span>;</span><br><span class="line">            proxy_set_header   X-Real-IP         <span class="variable">$remote_addr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><h5 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">     <span class="comment">#设定mime类型,类型由mime.type文件定义</span></span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    <span class="comment">#设定日志格式</span></span><br><span class="line">    access_log    /var/log/nginx/access.log;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设定负载均衡的服务器列表</span></span><br><span class="line">    upstream load_balance_server &#123;</span><br><span class="line">        <span class="comment">#weigth参数表示权值，权值越高被分配到的几率越大</span></span><br><span class="line">        server 192.168.1.11:80   weight=5;</span><br><span class="line">        server 192.168.1.12:80   weight=1;</span><br><span class="line">        server 192.168.1.13:80   weight=6;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">#HTTP服务器</span></span><br><span class="line">   server &#123;</span><br><span class="line">        <span class="comment">#侦听80端口</span></span><br><span class="line">        listen       80;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">        server_name  www.helloworld.com;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#对所有请求进行负载均衡请求</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            root        /root;                 <span class="comment">#定义服务器的默认网站根目录位置</span></span><br><span class="line">            index       index.html index.htm;  <span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">            proxy_pass  http://load_balance_server ;<span class="comment">#请求转向load_balance_server 定义的服务器列表</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#以下是一些反向代理的配置(可选择性配置)</span></span><br><span class="line">            <span class="comment">#proxy_redirect off;</span></span><br><span class="line">            proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span></span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_connect_timeout 90;          <span class="comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">            proxy_send_timeout 90;             <span class="comment">#后端服务器数据回传时间(代理发送超时)</span></span><br><span class="line">            proxy_read_timeout 90;             <span class="comment">#连接成功后，后端服务器响应时间(代理接收超时)</span></span><br><span class="line">            proxy_buffer_size 4k;              <span class="comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span></span><br><span class="line">            proxy_buffers 4 32k;               <span class="comment">#proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span></span><br><span class="line">            proxy_busy_buffers_size 64k;       <span class="comment">#高负荷下缓冲大小（proxy_buffers*2）</span></span><br><span class="line">            proxy_temp_file_write_size 64k;    <span class="comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span></span><br><span class="line"></span><br><span class="line">            client_max_body_size 10m;          <span class="comment">#允许客户端请求的最大单文件字节数</span></span><br><span class="line">            client_body_buffer_size 128k;      <span class="comment">#缓冲区代理缓冲用户端请求的最大字节数</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="单点故障"><a href="#单点故障" class="headerlink" title="单点故障"></a>单点故障</h4><p>Keepalived + Nginx 实现高可用，Keepalived 是一个高可用解决方案，主要是用来防止服务器单点发生故障，可以通过和Nginx 配合来实现Web 服务的高可用。</p>
<h4 id="HTTPS-反向代理"><a href="#HTTPS-反向代理" class="headerlink" title="HTTPS 反向代理"></a>HTTPS 反向代理</h4><h5 id="配置文件-2"><a href="#配置文件-2" class="headerlink" title="配置文件"></a>配置文件</h5><p>其他配置同HTTP 配置一样，只是在Server 的部分不一致。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#HTTPS服务器</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="comment">#监听443端口，443为知名端口号，主要用于HTTPS协议</span></span><br><span class="line">    listen       443 ssl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">    server_name  www.helloworld.com;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#ssl证书文件位置(常见证书文件格式为：crt/pem)</span></span><br><span class="line">    ssl_certificate      cert.pem;</span><br><span class="line">    <span class="comment">#ssl证书key位置</span></span><br><span class="line">    ssl_certificate_key  cert.key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#ssl配置参数（选择性配置）</span></span><br><span class="line">    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line">    <span class="comment">#数字签名，此处使用MD5</span></span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于前端页面资源展示</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /root;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 以前端访问静态资源接口代理后端api接口</span></span><br><span class="line">    location /vgbh/dog/ &#123;</span><br><span class="line">        proxy_set_header X_Forwarded_For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h4><p>使用 Nginx 可以非常快速便捷的搭建一个简易的文件服务。</p>
<p>Nginx 中的配置要点：</p>
<ul>
<li>将 autoindex 开启可以显示目录，默认不开启。</li>
<li>将 autoindex_exact_size 开启可以显示文件的大小。</li>
<li>将 autoindex_localtime 开启可以显示文件的修改时间。</li>
<li>root 用来设置开放为文件服务的根路径。</li>
<li>charset 设置为 charset utf-8,gbk;。</li>
</ul>
<h5 id="配置文件-3"><a href="#配置文件-3" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">autoindex on;<span class="comment"># 显示目录</span></span><br><span class="line">autoindex_exact_size on;<span class="comment"># 显示文件大小</span></span><br><span class="line">autoindex_localtime on;<span class="comment"># 显示文件时间</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    charset      utf-8,gbk; <span class="comment"># windows 服务器下设置后，依然乱码，暂时无解</span></span><br><span class="line">    listen       9050 default_server;</span><br><span class="line">    listen       [::]:9050 default_server;</span><br><span class="line">    server_name  _;</span><br><span class="line">    root         /share/fs;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	error_page 404 /404.html;</span><br><span class="line">		location = /40x.html &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	error_page 500 502 503 504 /50x.html;</span><br><span class="line">		location = /50x.html &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="跨域解决方案"><a href="#跨域解决方案" class="headerlink" title="跨域解决方案"></a>跨域解决方案</h4><p>web 领域开发中，经常采用前后端分离模式。各自独立的 web app 在互相访问时，势必存在跨域问题。<br>解决跨域问题一般有两种思路：</p>
<ul>
<li>CORS<br> 在后端服务器设置HTTP 响应头，把你需要运行访问的域名加入加入Access-Control-Allow-Origin 中。</li>
<li>jsonp<br> 把后端根据请求，构造json 数据，并返回，前端用jsonp 跨域。</li>
</ul>
<h5 id="配置文件-4"><a href="#配置文件-4" class="headerlink" title="配置文件"></a>配置文件</h5><p>在enable-cors.conf 文件中设置cors ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># allow origin list</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$ACAO</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># set single origin</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_origin</span> ~* (www.helloworld.com)$) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$ACAO</span> <span class="variable">$http_origin</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$cors</span> = <span class="string">&quot;trueget&quot;</span>) &#123;</span><br><span class="line">    add_header <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="string">&quot;<span class="variable">$http_origin</span>&quot;</span>;</span><br><span class="line">    add_header <span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">    add_header <span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class="string">&#x27;GET, POST, OPTIONS&#x27;</span>;</span><br><span class="line">    add_header <span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class="string">&#x27;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = <span class="string">&#x27;OPTIONS&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$cors</span> <span class="string">&quot;<span class="variable">$&#123;cors&#125;</span>options&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$cors</span> <span class="string">&quot;<span class="variable">$&#123;cors&#125;</span>get&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$cors</span> <span class="string">&quot;<span class="variable">$&#123;cors&#125;</span>post&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 在Nginx 配置中include enable-cors.conf 来引入跨域配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">upstream front_server&#123;</span><br><span class="line">  server www.helloworld.com:9000;</span><br><span class="line">&#125;</span><br><span class="line">upstream api_server&#123;</span><br><span class="line">  server www.helloworld.com:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen       80;</span><br><span class="line">  server_name  www.helloworld.com;</span><br><span class="line"></span><br><span class="line">  location ~ ^/api/ &#123;</span><br><span class="line">    include enable-cors.conf;</span><br><span class="line">    proxy_pass http://api_server;</span><br><span class="line">    rewrite <span class="string">&quot;^/api/(.*)$&quot;</span> /<span class="variable">$1</span> <span class="built_in">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location ~ ^/ &#123;</span><br><span class="line">    proxy_pass http://front_server;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="静态站点配置"><a href="#静态站点配置" class="headerlink" title="静态站点配置"></a>静态站点配置</h4><h5 id="配置文件-5"><a href="#配置文件-5" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/javascript image/jpeg image/gif image/png;</span><br><span class="line">    gzip_vary on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  static.zp.cn;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root /app/dist;</span><br><span class="line">            index index.html;</span><br><span class="line">            <span class="comment">#转发任何请求到 index.html</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 然后添加HOST：<br>127.0.0.1 static.zp.cn</p>
<hr>

<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><hr>

<h3 id="个人备注"><a href="#个人备注" class="headerlink" title="个人备注"></a>个人备注</h3><p><strong>此博客内容均为作者学习所做笔记，侵删！</strong><br><strong>若转作其他用途，请注明来源！</strong></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Nginx/" rel="tag"># Nginx</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/MySQL-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%92%8C%E6%8F%90%E9%AB%98/" rel="prev" title="MySQL-快速入门和提高">
      <i class="fa fa-chevron-left"></i> MySQL-快速入门和提高
    </a></div>
      <div class="post-nav-item">
    <a href="/%E4%BD%8D%E8%BF%90%E7%AE%97%E7%9A%84%E5%A5%87%E6%80%9D%E5%A6%99%E6%83%B3/" rel="next" title="位运算的奇思妙想">
      位运算的奇思妙想 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Nginx%E5%AE%89%E8%A3%85"><span class="nav-number">1.1.</span> <span class="nav-text">Nginx安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%B9%E7%82%B9"><span class="nav-number">1.2.</span> <span class="nav-text">特点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4"><span class="nav-number">1.3.</span> <span class="nav-text">命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.4.</span> <span class="nav-text">目录建议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80"><span class="nav-number">2.</span> <span class="nav-text">基础</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E9%80%94"><span class="nav-number">2.1.</span> <span class="nav-text">用途</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nginx-%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.</span> <span class="nav-text">Nginx 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE-nginx-conf"><span class="nav-number">2.2.1.</span> <span class="nav-text">默认配置 - nginx.conf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.2.2.</span> <span class="nav-text">配置示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.3.</span> <span class="nav-text">事件模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">2.4.</span> <span class="nav-text">架构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E9%AB%98"><span class="nav-number">3.</span> <span class="nav-text">提高</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%8C%96%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.1.</span> <span class="nav-text">模块化设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F"><span class="nav-number">3.2.</span> <span class="nav-text">请求方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8"><span class="nav-number">3.3.</span> <span class="nav-text">事件驱动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84"><span class="nav-number">3.4.</span> <span class="nav-text">设计架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%90%86%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.5.</span> <span class="nav-text">代理设计</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95"><span class="nav-number">4.</span> <span class="nav-text">面试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">5.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">5.1.</span> <span class="nav-text">HTTP 反向代理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">5.1.1.</span> <span class="nav-text">配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">5.2.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E7%82%B9%E6%95%85%E9%9A%9C"><span class="nav-number">5.3.</span> <span class="nav-text">单点故障</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTPS-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">5.4.</span> <span class="nav-text">HTTPS 反向代理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="nav-number">5.4.1.</span> <span class="nav-text">配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">5.5.</span> <span class="nav-text">文件服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-3"><span class="nav-number">5.5.1.</span> <span class="nav-text">配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">5.6.</span> <span class="nav-text">跨域解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-4"><span class="nav-number">5.6.1.</span> <span class="nav-text">配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">5.7.</span> <span class="nav-text">静态站点配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-5"><span class="nav-number">5.7.1.</span> <span class="nav-text">配置文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AA%E4%BA%BA%E5%A4%87%E6%B3%A8"><span class="nav-number">7.</span> <span class="nav-text">个人备注</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="vgbhfive"
      src="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <p class="site-author-name" itemprop="name">vgbhfive</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/vgbhfive" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;vgbhfive" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:vgbhfive@foxmail.com" title="E-Mail → mailto:vgbhfive@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">陕ICP20002937号 </a>
  </div>

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">vgbhfive</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '2ff0dea213e4c7c0bbcc',
      clientSecret: '7f3d808240b513b00a1dbf20d725809acc316b67',
      repo        : 'vgbhfive.github.io',
      owner       : 'vgbhfive',
      admin       : ['vgbhfive'],
      id          : '7d496df2bee390082ec9ed375606cc42',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
