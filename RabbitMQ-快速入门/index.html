<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="G-QBK8PCQC9B">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.vgbhfive.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="基础AMQPAMQP，即Advanced Message Queuing Protocol，一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。 基于此协议的客户端与消息中间件可传递消息，并不受客户端&#x2F;中间件不同产品，不同的开发语言等条件的限制。 消息队列MQ 全称为Message Queue, 消息队列。是一种应用程序对应用程序的通信方">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ-快速入门">
<meta property="og:url" content="https://blog.vgbhfive.cn/RabbitMQ-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Vgbhfive&#39;s Blog">
<meta property="og:description" content="基础AMQPAMQP，即Advanced Message Queuing Protocol，一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。 基于此协议的客户端与消息中间件可传递消息，并不受客户端&#x2F;中间件不同产品，不同的开发语言等条件的限制。 消息队列MQ 全称为Message Queue, 消息队列。是一种应用程序对应用程序的通信方">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/09/28/egzxB1duYqrQlSG.png">
<meta property="og:image" content="https://i.loli.net/2020/09/28/fyG5WI7jPoRC2cv.png">
<meta property="og:image" content="https://i.loli.net/2020/09/28/djXYVOJqHRNMt2s.png">
<meta property="og:image" content="https://i.loli.net/2020/09/28/E9XhFdWVxfvgZKs.png">
<meta property="og:image" content="https://i.loli.net/2020/09/08/o8AVq2vyYJSuQ6U.jpg">
<meta property="article:published_time" content="2020-09-07T12:53:23.000Z">
<meta property="article:modified_time" content="2021-04-16T16:17:48.000Z">
<meta property="article:author" content="vgbhfive">
<meta property="article:tag" content="MQ">
<meta property="article:tag" content="RabbitMQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/09/28/egzxB1duYqrQlSG.png">

<link rel="canonical" href="https://blog.vgbhfive.cn/RabbitMQ-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>RabbitMQ-快速入门 | Vgbhfive's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Vgbhfive's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Vgbhfive's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-pictures">

    <a href="/pictures/" rel="section"><i class="fa fa-th fa-fw"></i>Pictures</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.vgbhfive.cn/RabbitMQ-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
      <meta itemprop="name" content="vgbhfive">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Vgbhfive's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RabbitMQ-快速入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-07 20:53:23" itemprop="dateCreated datePublished" datetime="2020-09-07T20:53:23+08:00">2020-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-17 00:17:48" itemprop="dateModified" datetime="2021-04-17T00:17:48+08:00">2021-04-17</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="AMQP"><a href="#AMQP" class="headerlink" title="AMQP"></a>AMQP</h3><p>AMQP，即<code>Advanced Message Queuing Protocol</code>，一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。</p>
<p>基于此协议的客户端与消息中间件可传递消息，并不受客户端&#x2F;中间件不同产品，不同的开发语言等条件的限制。</p>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><p>MQ 全称为<code>Message Queue</code>, 消息队列。是一种应用程序对应用程序的通信方法。应用程序通过读写出入队列的消息（针对应用程序的数据）来通信，而无需专用连接来链接它们。</p>
<p>消息传递指的是程序之间通过在消息中发送数据进行通信，而不是通过直接调用彼此来通信。队列的使用除去了接收和发送应用程序同时执行的要求。</p>
<p>在项目中，将一些无需即时返回且耗时的操作提取出来，进行了异步处理，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而提高了系统的吞吐量。</p>
<span id="more"></span>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>在使用 RabbitMQ 之前，你需要在你的本地安装 RabbitMQ Server 端，但是在安装 RabbitMQ Server 之前，你还需要安装 erlang 。</p>
<p>我的本地系统是 Windows 10，所以你只需要去 erlang 官方下载对应的安装包即可。<br>在安装完成后，还需要配置环境变量到 PATH 中，验证安装成功命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erl</span><br></pre></td></tr></table></figure>

<h3 id="版本简介"><a href="#版本简介" class="headerlink" title="版本简介"></a>版本简介</h3><p>RabbitMQ 3.8.8<br>Windows 10<br>erlang V11.0</p>
<hr>

<h2 id="RabbitMQ-介绍"><a href="#RabbitMQ-介绍" class="headerlink" title="RabbitMQ 介绍"></a>RabbitMQ 介绍</h2><h3 id="基础概念介绍"><a href="#基础概念介绍" class="headerlink" title="基础概念介绍"></a>基础概念介绍</h3><ul>
<li>Message<br>消息由消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成，这些属性包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-<br>该消息可能需要持久性存储）等。</li>
<li>Publisher<br>消息的生产者，也是一个向交换器发布消息的客户端应用程序。</li>
<li>Exchange<br>交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。<br>Exchange有4种类型：direct(默认)，fanout, topic, 和headers，不同类型的Exchange转发消息的策略有所区别</li>
<li>Queue<br>消息队列，用来保存消息直到发送给消费者。它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直在队列里面，等待消费者连接到这个队列将其取走。</li>
<li>Binding<br>绑定，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则，所以可以将交换器理解成一个由绑定构成的路由表。Exchange 和Queue的绑定可以是多对多的关系。</li>
<li>Connection<br>网络连接，比如一个TCP连接。</li>
<li>Channel<br>信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内的虚拟连接，AMQP 命令都是通过信道发出去的，不管是发布消息、订阅队列还是接收消息，这些动作都是通过信道完成。因为对于操作系统来说建立和销毁 TCP 都是非常昂贵的开销，所以引入了信道的概念，以复用一条 TCP 连接</li>
<li>Consumer<br>消息的消费者，表示一个从消息队列中取得消息的客户端应用程序。</li>
<li>Virtual Host<br>虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加<br>密环境的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥有<br>自己的队列、交换器、绑定和权限机制。vhost 是 AMQP 概念的基础，必须在连接时指定，<br>RabbitMQ 默认的 vhost 是 &#x2F; 。</li>
<li>Broker<br>表示消息队列服务器实体</li>
</ul>
<p><img src="https://i.loli.net/2020/09/28/egzxB1duYqrQlSG.png" alt="20200409173505666.png"></p>
<h3 id="消息流程"><a href="#消息流程" class="headerlink" title="消息流程"></a>消息流程</h3><p>AMQP模型中，消息在producer中产生，发送到MQ的exchange 上，exchange 根据配置的路由方式发到相应的Queue 上，Queue 又将消息发送给consumer ，消息从queue 到consumer 有push 和pull 两种方式。 </p>
<p>消息队列的使用过程大概如下：</p>
<ul>
<li>客户端连接到消息队列服务器，打开一个channel 。</li>
<li>客户端声明一个exchange ，并设置相关属性。</li>
<li>客户端声明一个queue ，并设置相关属性。</li>
<li>客户端使用routing key ，在exchange 和queue 之间建立好绑定关系。</li>
<li>客户端投递消息到exchange 。</li>
</ul>
<p>exchange 接收到消息后，就根据消息的key 和已经设置的binding ，进行消息路由，将消息投递到一个或多个队列里。<br>exchange 也有几个类型，完全根据key 进行投递的叫做Direct 交换机，例如，绑定时设置了routing key 为”abc” ，那么客户端提交的消息，只有设置了key 为”abc” 的才会投递到队列。</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>启动监控管理器：rabbitmq-plugins enable rabbitmq_management<br>关闭监控管理器：rabbitmq-plugins disable rabbitmq_management<br>启动rabbitmq：rabbitmq-service start<br>关闭rabbitmq：rabbitmq-service stop<br>查看所有的队列：rabbitmqctl list_queues<br>清除所有的队列：rabbitmqctl reset<br>关闭应用：rabbitmqctl stop_app<br>启动应用：rabbitmqctl start_app</p>
<h4 id="用户和权限设置"><a href="#用户和权限设置" class="headerlink" title="用户和权限设置"></a>用户和权限设置</h4><p>添加用户：rabbitmqctl add_user username password<br>分配角色：rabbitmqctl set_user_tags username administrator<br>新增虚拟主机：rabbitmqctl add_vhost vhost_name<br>将新虚拟主机授权给新用户：rabbitmqctl set_permissions -p vhost_name username “.*” “.*” “.<em>”(后面三个”</em>”代表用户拥有配置、写、读全部权限)</p>
<h4 id="Exchange类型"><a href="#Exchange类型" class="headerlink" title="Exchange类型"></a>Exchange类型</h4><p>RabbitMQ目前共四种交换器类型：direct、fanout、topic、headers。headers 交换器和 direct 交换器完全一致，但性能差很多，用的比较少，所以只介绍三种类型</p>
<ul>
<li><p>Direct Exchange：<br><img src="https://i.loli.net/2020/09/28/fyG5WI7jPoRC2cv.png" alt="1.png"><br>这种模式根据路由键（routing key）去匹配Bindings中的 binding key，如果完全一致，就发送消息到对应Queue</p>
</li>
<li><p>Fanout Exchange：<br><img src="https://i.loli.net/2020/09/28/djXYVOJqHRNMt2s.png" alt="2.png"><br>这种模式是常见的发布订阅模式，发消息方式类似于子网广播，队列只要绑定到对应的Exchange，生产者发送消息过来，有绑定的队列都能接收消息</p>
</li>
<li><p>Topic Exchange：<br><img src="https://i.loli.net/2020/09/28/E9XhFdWVxfvgZKs.png" alt="3.png"><br>这种模式和Direct exchange有点像，不过Direct exchange是完全匹配，这种匹配方式是，先将路由键、bindings键根据点号隔开，# 表示匹配 0 个或多个单词， *表示匹配一个单词</p>
</li>
</ul>
<hr>

<h2 id="Demo-展示"><a href="#Demo-展示" class="headerlink" title="Demo 展示"></a>Demo 展示</h2><p><a target="_blank" rel="noopener" href="https://github.com/vgbhfive/SpringBootDemo/tree/master/rabbitmqdemo">https://github.com/vgbhfive/SpringBootDemo/tree/master/rabbitmqdemo</a></p>
<hr>

<h2 id="基础组态"><a href="#基础组态" class="headerlink" title="基础组态"></a>基础组态</h2><h3 id="基础参数配置"><a href="#基础参数配置" class="headerlink" title="基础参数配置"></a>基础参数配置</h3><p>RabbitMQ 基本上都带有默认的内置设置，所以在一些基础的场景下就已经够用了，所以当你需要在一些特别的场景下使用时，需要更改RabbitMQ 的配置。</p>
<p>大多数配置都是在rabbitmq.conf 文件中配置，大多数都是位于&#x2F;etc&#x2F;rabbitmq&#x2F;rabbitmq.conf 位置。<br><small>如果你实在是找不到对应的位置时，可以使用 rabbitmq-diagnostics status 命令。</small></p>
<p>在rabbitmq.conf 配置文件之外，你还会遇见另一个配置文件就是advanced.config ，这个配置文件采用的Erlang 经典配置，仅在必要的时候可以使用，一般建议都是使用rabbitmq.conf 配置文件。</p>
<h3 id="文件位置"><a href="#文件位置" class="headerlink" title="文件位置"></a>文件位置</h3><p>每个RabbitMQ 节点都有许多的文件和目录来加载配置，然而这些文件和目录的位置是可以修改的。</p>
<p>在配置环境变量和目录时，尽量不要使用特殊字符，比如<em>、？、</em>、！、[、]、{}、} 等字符。<br><small>另外在修改了对应的文件和目录后，请求包RabbitMQ 节点还依旧拥有权限访问对应的资源。</small></p>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>日志在检查问题或者检查系统的运行状态时是非常重要的。</p>
<p>日志文件名称：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.file=Rabbit.log</span><br></pre></td></tr></table></figure>

<p>日志文件目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.dir=/data/log/rabbit.log</span><br></pre></td></tr></table></figure>

<p>日志级别：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.level=info</span><br></pre></td></tr></table></figure>

<p>禁用日志文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.file=false</span><br></pre></td></tr></table></figure>

<h4 id="日志写入"><a href="#日志写入" class="headerlink" title="日志写入"></a>日志写入</h4><p>RabbitMQ节点始终会附加到日志文件，因此会保留完整的日志历史记录。默认情况下，Loger 不会执行日志文件轮换。</p>
<p>设置控制文件输出的日志文件旋转：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log.file.rotation.date # 旋转时间</span><br><span class="line">log.file.rotation.size # 旋转大小</span><br><span class="line">log.file.rotation.count # 旋转数量</span><br></pre></td></tr></table></figure>

<p>日志写入到控制台：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.console=true</span><br></pre></td></tr></table></figure>

<h4 id="服务日志"><a href="#服务日志" class="headerlink" title="服务日志"></a>服务日志</h4><p>在基于systemd 的Linux 发行版上，可以使用journalctl –system 检查系统服务日志。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --system | grep Rabbitmq</span><br></pre></td></tr></table></figure>

<h3 id="模式的导入与导出"><a href="#模式的导入与导出" class="headerlink" title="模式的导入与导出"></a>模式的导入与导出</h3><p>定义存储在内部数据库中，并在所有群集节点之间复制。集群中的每个节点都有其自己的所有定义副本。当定义的一部分更改时，将在单个事务中的所有节点上执行更新。这意味着在实践中，可以从任何群集节点导出定义并获得相同的结果。因此可以将定义导出到文件中，然后导入到另一个集群中或用于模式备份。</p>
<p>使用rabbitmqctl 导出模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">＃不需要启用管理插件，RabbitMQ 3.8.2中的新增功能</span><br><span class="line">rabbitmqctl export_definitions /path/to/definitions.file.json</span><br></pre></td></tr></table></figure>
<p>导入模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">＃不需要启用管理插件，RabbitMQ 3.8.2中的新增功能</span><br><span class="line">rabbitmqctl import_definitions /path/to/definitions.file.json</span><br></pre></td></tr></table></figure>

<p>在版本3.8.6 之后不需要再导入模式，只需要在配置文件中配置好对应的配置之后，重新启动即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">＃RabbitMQ 3.8.6中的新功能。</span><br><span class="line">＃不需要启用管理插件。</span><br><span class="line">load_definitions = /path/to/definitions/file.json</span><br></pre></td></tr></table></figure>

<h3 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h3><p>RabbitMQ 是一个多用户的系统，在你说知道的连接、交换、连接、绑定、用户权限、策略等一系列的东西都是属于虚拟主机，你可以将它理解为Nginx 中的服务模块。另外还有不同的一点在于RabbitMQ 的虚拟主机是通过Rabbitmqctl 或者HTTP API 创建或者删除的。</p>
<h4 id="创建虚拟主机"><a href="#创建虚拟主机" class="headerlink" title="创建虚拟主机"></a>创建虚拟主机</h4><p>使用Rabbitmqctl 创建虚拟主机five1，示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_vhost five1</span><br></pre></td></tr></table></figure>

<p>使用HTTP API 创建虚拟主机five2：（这里使用了curl 进行发送链接）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -u userename:pa$sw0rD -X PUT http://rabbitmq.local:15672/api/vhosts/five2</span><br></pre></td></tr></table></figure>

<h4 id="删除虚拟主机"><a href="#删除虚拟主机" class="headerlink" title="删除虚拟主机"></a>删除虚拟主机</h4><p>使用Rabbitmqctl 删除虚拟主机five1，示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl delete_vhost five1</span><br></pre></td></tr></table></figure>

<p>使用HTTP API 删除虚拟主机five2：（这里使用了curl 进行发送链接）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -u userename:pa$sw0rD -X DELETE http://rabbitmq.local:15672/api/vhosts/five2</span><br></pre></td></tr></table></figure>

<h4 id="限制虚拟主机"><a href="#限制虚拟主机" class="headerlink" title="限制虚拟主机"></a>限制虚拟主机</h4><p>设置最大连接数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_vhost_limits -p vhost_name &#x27;&#123;&quot;max-connections&quot;: 256&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p><small>正值：限制次数。0: 无限制。 负值：取消限制。</small></p>
<p>配置最大队列数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_vhost_limits -p vhost_name &#x27;&#123;“ max-queues”：1024&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p><small>正值：限制次数。负值：取消限制。</small></p>
<h3 id="心跳机制"><a href="#心跳机制" class="headerlink" title="心跳机制"></a>心跳机制</h3><p>如果消费者进程挂掉了（channel关闭， connection关闭，或者tcp连接丢失）， 没有发回确认信息， RMQ将认为消息没有被处理完， 将重新排队等待分配。</p>
<p>网络故障很多种，有时很微妙（比如，丢包比率和高）。 分布式的tcp连接采取适中的时间（比如Linux默认配置大约11分钟），方便操作系统检测。AMQP 0-9-1提供heartbeat(心跳）特性来确保应用服务层及时发现已崩溃的连接（和完全无相应的peers）。 心跳机制也能保证进程不被某些网络设备给杀掉。心跳包每半个超时时间发送一次。 丢失了两个心跳包， 连接被认为不可抵达。 不同的客户端有不同的提示， 但tcp连接都会被关闭。 当客户端检测到RMQ节点不可抵达（根据心跳判定）， 它需要重新连接（到服务器）。</p>
<hr>

<h2 id="认证和授权"><a href="#认证和授权" class="headerlink" title="认证和授权"></a>认证和授权</h2><hr>

<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>在我经历的大多数系统中，都不是很重视关于中间件的监控这块的内容，因此在生产出现问题时，很难及时、有效的找到问题。</p>
<p>RabbitMQ 在3.8 版本之前，都是依赖自己的管理监控页面来实现的，这对于生产环境来说，有很大的不便行并且存在一定的安全隐患。<br>但是在RabbitMQ 3.8 版本之后，官方强烈推荐使用Prometheus 和 Grafana 来搭建一套监控系统。</p>
<h3 id="基础架构和内核指标"><a href="#基础架构和内核指标" class="headerlink" title="基础架构和内核指标"></a>基础架构和内核指标</h3><p>运行在RabbitMQ 节点或应用的所有主机上应收集以下指标：</p>
<ul>
<li>CPU 统计信息</li>
<li>内存使用情况</li>
<li>虚拟内存统计信息</li>
<li>磁盘I&#x2F;O</li>
<li>挂载上用于节点数据目录的可用磁盘空间</li>
<li>beam.smp 中文件描述符和最大系统限制 </li>
<li>TCP 连接状态</li>
<li>网络吞吐量</li>
<li>网络延迟</li>
</ul>
<h3 id="监测频率"><a href="#监测频率" class="headerlink" title="监测频率"></a>监测频率</h3><p>许多监视系统会定期轮询其监视的服务。这样做的频率因工具而异，但通常是由管理员配置的。同时频繁的轮询可能会对受监视的系统产生负面影响。</p>
<p>在开发、测试、UAT 环境中，建议的度量标准间隔为15 秒，如果需要接近实时的监测效果，也请不要将时间设置为小于5 秒，这样轮询监测条件的影响会小一点。<br>但是在生产环境下，建议将度量标准间隔为30 ~ 60 秒之间，其中Promethues 对于API 的设置有效时间为15 秒一次。</p>
<h3 id="管理界面和外部监控软件"><a href="#管理界面和外部监控软件" class="headerlink" title="管理界面和外部监控软件"></a>管理界面和外部监控软件</h3><p>RabbitMQ 有自带的管理界面和HTTP API ，这些API 公开了许多的信息，主要是关于节点、连接、队列、消息速率等的指标信息。</p>
<ol>
<li><p>安装RabbitMQ Prometheus Plugin<br>将下载的插件拷贝到RabbitMQ的插件目录，rpm形式安装的RabbitMQ的插件目录位于&#x2F;usr&#x2F;lib&#x2F;rabbitmq&#x2F;plugins下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">accept-0.3.3.ez</span><br><span class="line">prometheus-3.4.0.ez</span><br><span class="line">prometheus_httpd-2.1.4.ez</span><br><span class="line">prometheus_process_collector-1.1.0.ez</span><br><span class="line">prometheus_rabbitmq_exporter-v3.6.12.1.ez</span><br></pre></td></tr></table></figure>
<p>同时启用插件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable accept</span><br><span class="line">rabbitmq-plugins enable prometheus</span><br><span class="line">rabbitmq-plugins enable prometheus_httpd</span><br><span class="line">rabbitmq-plugins enable prometheus_rabbitmq_exporter</span><br><span class="line">rabbitmq-plugins enable prometheus_process_collector</span><br></pre></td></tr></table></figure>
<p>重启RabbitMQ，访问 <a target="_blank" rel="noopener" href="http://localhost:15672/api/metrics">http://localhost:15672/api/metrics</a> 可以得到RabbitMQ Exporter 暴露的metrics 了。</p>
</li>
<li><p>配置Promethues</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;rabbitmq&#x27;</span><br><span class="line">    metrics_path: /api/metrics</span><br><span class="line">    static_configs:</span><br><span class="line">     - targets:</span><br><span class="line">        - 192.168.1.3:15672</span><br><span class="line">       labels:</span><br><span class="line">         instance: s3</span><br><span class="line">     - targets:</span><br><span class="line">        - 192.168.1.4:15672</span><br><span class="line">       labels:</span><br><span class="line">         instance: s4</span><br><span class="line">     - targets:</span><br><span class="line">        - 192.168.1.5:15672</span><br><span class="line">       labels:</span><br><span class="line">         instance: s5</span><br></pre></td></tr></table></figure>
</li>
<li><p>Grafana配置<br>下载Grafana Dashboard<br><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/deadtrickster/prometheus_rabbitmq_exporter/master/priv/dashboards/RabbitMQErlangVM.json%E3%80%82">https://raw.githubusercontent.com/deadtrickster/prometheus_rabbitmq_exporter/master/priv/dashboards/RabbitMQErlangVM.json。</a><br>将上面的dashboar 导入后需要做一些修改，加入host 变量，并修改各个图表的PromQL 加入host 变量作为查询条件，通过下拉列表选择查看不同rabbitmq 节点的Dashboard 。</p>
</li>
</ol>
<p><img src="https://i.loli.net/2020/09/08/o8AVq2vyYJSuQ6U.jpg" alt="rabbitmq-grafana.jpg"></p>
<h3 id="Rabbitmqadmin-HTTP-API命令行工具"><a href="#Rabbitmqadmin-HTTP-API命令行工具" class="headerlink" title="Rabbitmqadmin HTTP API命令行工具"></a>Rabbitmqadmin HTTP API命令行工具</h3><p>这个命令行管理工具需要Rabbitmqadmin 插件的支持，使用这个可以执行一些基于WebUI 的相同操作，并且这个插件可能对于自动化任务比较方便。同时这只是一个专门的HTTP 客户端，尽量不要用自己从自己的程序中调用Rabbitmqadmin 。</p>
<p><small><strong>Rabbitmqadmin 不能替代rabbitmqctl 或者rabbitmq-plugins 。</strong></small></p>
<p><small><strong>rabbitmqadmin和RabbitMQ HTTP API 的兼容性一致，需要相同的版本才可以适配！</strong></small></p>
<p>通过Rabbitmqadmin 可以获取的内容：</p>
<ul>
<li>列出交换，队列，绑定，虚拟主机，用户，权限，连接和通道</li>
<li>显示概述信息</li>
<li>声明和删除交换，队列，绑定，虚拟主机，用户和权限</li>
<li>发布并获取消息</li>
<li>关闭连接并清除队列</li>
<li>导入和导出配置</li>
</ul>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><ol>
<li><p>exchanges 列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqadmin -V test list exchanges</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取队列列表，其中包含详细信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqadmin -f long -d 3 list queues</span><br></pre></td></tr></table></figure>
</li>
<li><p>用其他用户连接其他虚拟主机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqadmin -H myserver -u simon -p simon list vhosts</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义一个交换exchange</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqadmin declare exchange name=my-new-exchange type=fanout</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><p>渠道是RabbitMQ 中一个很重要的概念，所以这部分我们有必要了解一下。</p>
<p>RabbitMQ支持多种协议：</p>
<ul>
<li>具有扩展功能的AMQP 0.9.1</li>
<li>AMQP 1.0 （尽管和上面的协议名称一致，但是他两确实是不同的协议）</li>
<li>MQTT 3.1.1</li>
<li>STOMP 1.0 ~ 1.2</li>
</ul>
<h4 id="基础-1"><a href="#基础-1" class="headerlink" title="基础"></a>基础</h4><p>RabbitMQ支持的所有协议都是基于TCP的，并假定存在长期连接（每个协议操作不会打开新连接）以提高效率。一个客户端库连接使用单个TCP连接。为了使客户端成功连接，目标RabbitMQ节点必须允许在特定协议特定端口上的连接。</p>
<p>客户端连接并成功通过RabbitMQ节点进行身份验证之后，它可以发布和使用消息，定义拓扑并执行协议中提供的，由客户端库和目标RabbitMQ节点支持的其他操作。</p>
<p>由于连接本来就应该长期存在，所以客户端通常通过注册订阅并传递（推送）消息给他们而不是轮询来消耗消息。</p>
<p>当不再需要连接时，应用程序必须关闭它们以节省资源。未能做到这一点的应用程序有最终耗尽其目标资源节点的风险。</p>
<p><strong>操作系统对单个进程可以 同时打开多少个TCP连接（套接字）有一个限制。</strong>该限制对于开发和某些QA环境通常是足够的。 必须将生产环境配置为使用更高的限制，以支持更多的并发客户端连接。</p>
<h4 id="协议的区别"><a href="#协议的区别" class="headerlink" title="协议的区别"></a>协议的区别</h4><ol>
<li><p>具有扩展功能的AMQP 0.9.1<br>AMQP 0.9.1 提供了一种通过单个TCP 连接进行多路复用的方法，这意味可以在同一个连接之上打开多个“轻量级连接”的通道，通过这些通道就可以进行对应的协议操作。<br>一个具有相同ID（编号）的通道被多次打开，向客户端发送错误后，连接将关闭。</p>
</li>
<li><p>AMQP 1.0<br>AMQP 1.0 提供了一种通过单个TCP 连接进行多路复用的方法，这样应用程序可以在单个连接上打开多个称为会话的“轻量级连接”。然后，应用程序设置一个或多个链接来发布和使用消息。<br>在AMQP 1.0中，大多数错误属于会话错误或链接错误。会话错误是不可恢复的，导致检测到该错误的对等方接收的所有操作都将被丢弃，直到会话终止。链接错误仅限于特定链接。由于可以在不影响链接会话的情况下附加和重新附加链接，因此实际上，应用程序可以在更正根本原因后（如果可能）重试失败的操作。</p>
</li>
<li><p>MQTT 3.1.1<br>MQTT 3.1.1 连接遵循上述流程。MQTT 支持可选身份验证。使用它时，RabbitMQ 使用一组预配置的凭据。<br>在MQTT 3.1中，服务器使用有限的方式将错误传达给客户端。主要方法是关闭客户端的TCP连接。这为开发人员提供了很少的上下文和有限的可见性。这是MQTT 3.1设计的基本限制。</p>
</li>
<li><p>STOMP 1.0 ~ 1.2<br>STOMP连接遵循下面流程。<br>在STOMP中，服务器通过发送错误帧 并关闭TCP连接来传达错误。该框架将在消息字段中包含一条错误消息。</p>
</li>
</ol>
<h4 id="连接生命周期"><a href="#连接生命周期" class="headerlink" title="连接生命周期"></a>连接生命周期</h4><p>客户端连接RabbitMQ，必须首先打开连接。此过程涉及多个步骤：</p>
<ul>
<li>应用程序配置它使用的客户端库以使用某个连接端点（例如主机名和端口）。</li>
<li>该库将主机名解析为一个或多个IP 地址。</li>
<li>该库将打开与目标IP地址和端口的TCP 连接。</li>
<li>服务器接受TCP 连接后，执行特定于协议的协商过程。</li>
<li>然后，服务器对客户端进行身份验证。</li>
<li>客户端现在可以执行操作，每个操作都涉及服务器的授权检查。</li>
</ul>
<h4 id="监控-1"><a href="#监控-1" class="headerlink" title="监控"></a>监控</h4><p>当前打开的客户端连接数和连接打开&#x2F;关闭率是应监视的系统的重要指标。常见的问题主要有：</p>
<ul>
<li>连接泄漏</li>
<li>高连接率</li>
</ul>
<p>连接泄露是指应用程序反复打开连接而不关闭它们，或者至少仅关闭其中一些连接的情况。<br>连接泄漏最终会耗尽文件句柄的节点（或多个目标节点），这意味着任何新的入站客户端，同级或CLI 工具连接都将被拒绝。并发连接数量的增加也增加了节点的内存消耗。</p>
<p>当一个系统的新打开连接率始终很高并且其关闭连接率始终很高时，据说该系统具有很高的连接交换率。这就说明应用程序使用的连接都是非常的短暂，连接交换率比较高的情况下，还是需要去检查一下TCP 堆栈，避免资源耗尽。</p>
<h4 id="资源使用"><a href="#资源使用" class="headerlink" title="资源使用"></a>资源使用</h4><p>每个连接都会消耗目标RabbitMQ节点上的内存和一个文件句柄。</p>
<p>连接的TCP 缓冲区使用了大部分内存。它们的大小可以随着减小，从而以显著降低连接吞吐量为代价，从而节省每个连接的内存消耗。</p>
<p>RabbitMQ节点可以打开的最大文件句柄数受<strong>内核限制</strong>，并且必须提高以支持大量连接。</p>
<h4 id="支持大量连接"><a href="#支持大量连接" class="headerlink" title="支持大量连接"></a>支持大量连接</h4><p>由于连接消耗资源，因此要维持大量并发连接，就需要减少资源消耗或提供更多的资源或节点。实际上，这两个选项可以结合使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">＃将间隔设置为60秒</span><br><span class="line">collect_statistics_interval = 60000</span><br></pre></td></tr></table></figure>

<h4 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h4><p>客户端连接可以使用TLS加密。TLS也可以用作身份验证客户端的其他或主要方式。</p>
<h4 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h4><p>发布消息的连接可能会超过系统的极限，这很可能是繁忙的队列和执行复制的队列。发生这种情况时，将流控制应用于发布连接。这样仅使用消息的连接不受应用于发布者的流控制的影响。</p>
<p>对于使用自动确认消息的模式，很有可能在连接和通道写入TCP 连接时就会得到流量控制。</p>
<h3 id="通道Channel"><a href="#通道Channel" class="headerlink" title="通道Channel"></a>通道Channel</h3><p>前面有写连接的部分，所以建议应该先学会连接的部分，再来学通道，毕竟没有连接就没有通道。</p>
<p>某些程序需要与服务器进行多个连接，但是又不希望有多个TCP 连接，所以AMQP 0.9.1 协议可以在同一个TCP 连接上进行多通道复用。</p>
<p>客户端执行的每个协议操作都在通道上发生。特定通道上的通信与另一通道上的通信完全分开，因此每种协议方法还带有一个通道ID（又称通道号），该整数是代理和客户端都使用该整数确定该方法用于哪个通道的。</p>
<p>通道仅存在于连接的上下文中，而不是单独存在的。关闭连接后，其上的所有通道也将关闭。</p>
<p>对于使用多个线程&#x2F;进程进行处理的应用程序，很常见的是为每个线程&#x2F;进程打开一个新通道，而不在它们之间共享通道。</p>
<h4 id="渠道生命周期"><a href="#渠道生命周期" class="headerlink" title="渠道生命周期"></a>渠道生命周期</h4><p>应用程序在成功连接后会立即打开通道，然后会自动分配一个通道ID给新建的通道。<br>但通道不在需要使用时，应该及时关闭通道，并将资源回收。</p>
<h4 id="通道异常"><a href="#通道异常" class="headerlink" title="通道异常"></a>通道异常</h4><p>常见错误示例：</p>
<ul>
<li>重新生命队列或者将不匹配的属性进行交换，将会抛出406 PRECONDITION_FAILED 异常。</li>
<li>用户访问权限不足的资源，将会抛出403 ACCESS_REFUSED 异常。</li>
<li>绑定不存在的队列或者不存在的交互，将会抛出404 NOT_FOUND 异常。</li>
<li>使用不存在的队列或者使用不存在的交换，将会抛出404 NOT_FOUND 异常。</li>
<li>从声明连接之外的连接使用独占队列，将会抛出405 RESOURCE_LOCKED 异常。</li>
</ul>
<p>通道监测常见问题：</p>
<ul>
<li>通道泄漏，通道泄漏是指应用程序重复打开通道而不关闭通道，或者至少关闭其中一些通道​​的情况。</li>
<li>高渠道流失率，当一个系统的新打开通道的速率始终很高，而关闭通道的速率始终很高时，则据说该系统具有较高的通道流失率。这通常意味着应用程序使用寿命短的通道，或者由于通道级异常而经常关闭通道。</li>
</ul>
<h4 id="最大连接数"><a href="#最大连接数" class="headerlink" title="最大连接数"></a>最大连接数</h4><p>客户端和服务器在连接时协商可以同时在一个连接上打开的最大通道数。该值对于RabbitMQ和客户端库都是可配置的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">＃同一连接上不能再打开100个通道</span><br><span class="line">channel_max = 100</span><br></pre></td></tr></table></figure>

<h4 id="CLI-Tools"><a href="#CLI-Tools" class="headerlink" title="CLI Tools"></a>CLI Tools</h4><ol>
<li><p>消费者连接服务器的连接及通道数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl list_connections name channels -q</span><br><span class="line"># =&gt; name    channels</span><br><span class="line"># =&gt; 127.0.0.1:52956 -&gt; 127.0.0.1:5672    10</span><br><span class="line"># =&gt; 127.0.0.1:52964 -&gt; 127.0.0.1:5672    33</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看通道信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl list_channels -q</span><br><span class="line"># =&gt; pid user    consumer_count  messages_unacknowledged</span><br><span class="line"># =&gt; &lt;rabbit@mercurio.3.815.0&gt; guest   0   0</span><br><span class="line"># =&gt; &lt;rabbit@mercurio.3.820.0&gt; guest   0   0</span><br><span class="line"># =&gt; &lt;rabbit@mercurio.3.824.0&gt; guest   0   0</span><br><span class="line"># =&gt; &lt;rabbit@mercurio.3.828.0&gt; guest   0   0</span><br><span class="line"># =&gt; &lt;rabbit@mercurio.3.832.0&gt; guest   0   0</span><br><span class="line"># =&gt; &lt;rabbit@mercurio.3.839.0&gt; guest   0   0</span><br><span class="line"># =&gt; &lt;rabbit@mercurio.3.840.0&gt; guest   0   0</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="事件交换插件（event-exchange-plugin）"><a href="#事件交换插件（event-exchange-plugin）" class="headerlink" title="事件交换插件（event exchange plugin）"></a>事件交换插件（event exchange plugin）</h3><p>客户端连接服务器、使用通道、使用队列等，使用者和系统的其他部分进行交互都会生成事件。而这些对于监控和监测来说，是一个很好的切入点。</p>
<p>rabbitmq-event-exchange 是一个插件，使用内部事件并将其重新发布到主题交换，从而将事件公开给客户端（应用程序）。<br>激活rabbitmq-event-exchange ，不需要配置，直接激活即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_event_exchange</span><br></pre></td></tr></table></figure>

<h4 id="事件Events"><a href="#事件Events" class="headerlink" title="事件Events"></a>事件Events</h4><ol>
<li>队列、交换和绑定事件</li>
</ol>
<ul>
<li>queue.deleted</li>
<li>queue.created</li>
<li>exchange.created</li>
<li>exchange.deleted</li>
<li>binding.created</li>
<li>binding.deleted</li>
</ul>
<ol start="2">
<li>连接和通道事件</li>
</ol>
<ul>
<li>connection.created</li>
<li>connection.closed</li>
<li>channel.created</li>
<li>channel.closed</li>
</ul>
<ol start="3">
<li>消费者事件</li>
</ol>
<ul>
<li>consumer.created</li>
<li>consumer.deleted</li>
</ul>
<ol start="4">
<li>策略、参数事件</li>
</ol>
<ul>
<li>policy.set</li>
<li>policy.cleared</li>
<li>parameter.set</li>
<li>parameter.cleared</li>
</ul>
<ol start="5">
<li>虚拟主机事件</li>
</ol>
<ul>
<li>vhost.created</li>
<li>vhost.deleted</li>
</ul>
<ol start="6">
<li>用户相关事件</li>
</ol>
<ul>
<li>user.authentication.success</li>
<li>user.authentication.failure</li>
<li>user.created</li>
<li>user.deleted</li>
<li>user.password.changed</li>
<li>user.password.cleared</li>
<li>user.tags.set</li>
</ul>
<ol start="7">
<li>权限事件</li>
</ol>
<ul>
<li>permission.created</li>
<li>permission.deleted</li>
</ul>
<ol start="8">
<li>插件事件</li>
</ol>
<ul>
<li>shovel.worker.status</li>
<li>shovel.worker.removed</li>
</ul>
<ol start="9">
<li>联盟事件</li>
</ol>
<ul>
<li>federation.link.status</li>
<li>federation.link.removed</li>
</ul>
<h3 id="使用Wireshark流量捕获"><a href="#使用Wireshark流量捕获" class="headerlink" title="使用Wireshark流量捕获"></a>使用Wireshark流量捕获</h3><p>Wireshark 2.0 包含对AMQP 流量检查和分析的增强支持。可以剖析（解析，可视化，过滤）AMQP 0-9-1 和AMQP 1.0 流量，包括AMQP 0-9-1 Errata 和RabbitMQ Extensions。</p>
<p>Wireshark 2.0 与tcpdump、libpcap 具有相同的基础内容，可用于检查在服务器环境中获取的pcap 流量捕获文件。</p>
<hr>

<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><hr>

<h2 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h2><hr>

<h2 id="个人备注"><a href="#个人备注" class="headerlink" title="个人备注"></a>个人备注</h2><p><strong>此博客内容均为作者学习所做笔记，侵删！</strong><br><strong>若转作其他用途，请注明来源！</strong></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MQ/" rel="tag"># MQ</a>
              <a href="/tags/RabbitMQ/" rel="tag"># RabbitMQ</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/SpringBoot%E5%BC%95%E5%85%A5MP-%E6%8A%A5%E9%94%99ClassNotFoundException/" rel="prev" title="SpringBoot引入MP 报错ClassNotFoundException">
      <i class="fa fa-chevron-left"></i> SpringBoot引入MP 报错ClassNotFoundException
    </a></div>
      <div class="post-nav-item">
    <a href="/Linux-curl%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" rel="next" title="Linux_curl使用指南">
      Linux_curl使用指南 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AMQP"><span class="nav-number">1.1.</span> <span class="nav-text">AMQP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">1.2.</span> <span class="nav-text">消息队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.3.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E7%AE%80%E4%BB%8B"><span class="nav-number">1.4.</span> <span class="nav-text">版本简介</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ-%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.</span> <span class="nav-text">RabbitMQ 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.1.</span> <span class="nav-text">基础概念介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">消息流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">2.3.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%92%8C%E6%9D%83%E9%99%90%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.3.1.</span> <span class="nav-text">用户和权限设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exchange%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.3.2.</span> <span class="nav-text">Exchange类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo-%E5%B1%95%E7%A4%BA"><span class="nav-number">3.</span> <span class="nav-text">Demo 展示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%BB%84%E6%80%81"><span class="nav-number">4.</span> <span class="nav-text">基础组态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.</span> <span class="nav-text">基础参数配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE"><span class="nav-number">4.2.</span> <span class="nav-text">文件位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97"><span class="nav-number">4.3.</span> <span class="nav-text">日志</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%86%99%E5%85%A5"><span class="nav-number">4.3.1.</span> <span class="nav-text">日志写入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="nav-number">4.3.2.</span> <span class="nav-text">服务日志</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E4%B8%8E%E5%AF%BC%E5%87%BA"><span class="nav-number">4.4.</span> <span class="nav-text">模式的导入与导出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="nav-number">4.5.</span> <span class="nav-text">虚拟主机</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="nav-number">4.5.1.</span> <span class="nav-text">创建虚拟主机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="nav-number">4.5.2.</span> <span class="nav-text">删除虚拟主机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="nav-number">4.5.3.</span> <span class="nav-text">限制虚拟主机</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6"><span class="nav-number">4.6.</span> <span class="nav-text">心跳机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83"><span class="nav-number">5.</span> <span class="nav-text">认证和授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7"><span class="nav-number">6.</span> <span class="nav-text">监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E5%92%8C%E5%86%85%E6%A0%B8%E6%8C%87%E6%A0%87"><span class="nav-number">6.1.</span> <span class="nav-text">基础架构和内核指标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%B5%8B%E9%A2%91%E7%8E%87"><span class="nav-number">6.2.</span> <span class="nav-text">监测频率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2%E5%92%8C%E5%A4%96%E9%83%A8%E7%9B%91%E6%8E%A7%E8%BD%AF%E4%BB%B6"><span class="nav-number">6.3.</span> <span class="nav-text">管理界面和外部监控软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rabbitmqadmin-HTTP-API%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="nav-number">6.4.</span> <span class="nav-text">Rabbitmqadmin HTTP API命令行工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">6.4.1.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5"><span class="nav-number">6.5.</span> <span class="nav-text">连接</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80-1"><span class="nav-number">6.5.1.</span> <span class="nav-text">基础</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">6.5.2.</span> <span class="nav-text">协议的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">6.5.3.</span> <span class="nav-text">连接生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-1"><span class="nav-number">6.5.4.</span> <span class="nav-text">监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E4%BD%BF%E7%94%A8"><span class="nav-number">6.5.5.</span> <span class="nav-text">资源使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%AF%E6%8C%81%E5%A4%A7%E9%87%8F%E8%BF%9E%E6%8E%A5"><span class="nav-number">6.5.6.</span> <span class="nav-text">支持大量连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TLS"><span class="nav-number">6.5.7.</span> <span class="nav-text">TLS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="nav-number">6.5.8.</span> <span class="nav-text">流量控制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E9%81%93Channel"><span class="nav-number">6.6.</span> <span class="nav-text">通道Channel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B8%A0%E9%81%93%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">6.6.1.</span> <span class="nav-text">渠道生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E9%81%93%E5%BC%82%E5%B8%B8"><span class="nav-number">6.6.2.</span> <span class="nav-text">通道异常</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E5%A4%A7%E8%BF%9E%E6%8E%A5%E6%95%B0"><span class="nav-number">6.6.3.</span> <span class="nav-text">最大连接数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CLI-Tools"><span class="nav-number">6.6.4.</span> <span class="nav-text">CLI Tools</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E4%BA%A4%E6%8D%A2%E6%8F%92%E4%BB%B6%EF%BC%88event-exchange-plugin%EF%BC%89"><span class="nav-number">6.7.</span> <span class="nav-text">事件交换插件（event exchange plugin）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6Events"><span class="nav-number">6.7.1.</span> <span class="nav-text">事件Events</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Wireshark%E6%B5%81%E9%87%8F%E6%8D%95%E8%8E%B7"><span class="nav-number">6.8.</span> <span class="nav-text">使用Wireshark流量捕获</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C"><span class="nav-number">7.</span> <span class="nav-text">网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F"><span class="nav-number">8.</span> <span class="nav-text">分布式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AA%E4%BA%BA%E5%A4%87%E6%B3%A8"><span class="nav-number">9.</span> <span class="nav-text">个人备注</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="vgbhfive"
      src="https://i.loli.net/2019/12/10/JF3dKDSkZoPz7h6.jpg">
  <p class="site-author-name" itemprop="name">vgbhfive</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">135</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/vgbhfive" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;vgbhfive" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:vgbhfive@foxmail.com" title="E-Mail → mailto:vgbhfive@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">陕ICP20002937号 </a>
  </div>

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">vgbhfive</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '2ff0dea213e4c7c0bbcc',
      clientSecret: '7f3d808240b513b00a1dbf20d725809acc316b67',
      repo        : 'vgbhfive.github.io',
      owner       : 'vgbhfive',
      admin       : ['vgbhfive'],
      id          : 'da2b54d372891ce097fc6583a8aefc6b',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
